<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CrowdVote - Free Market Representation{% endblock %}</title>
    <meta name="description" content="CrowdVote enables communities to make decisions through STAR voting and delegative democracy.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Alpine.js for dropdown functionality -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Jdenticon for user avatars -->
    <script src="https://cdn.jsdelivr.net/npm/jdenticon@3.3.0/dist/jdenticon.min.js" async
            integrity="sha384-LfouGM03m83ArVtne1JPk926e3SGD0Tz8XHtW2OKGsgeBU/UfR0Fa8eX+UlwSSAZ" crossorigin="anonymous">
    </script>
    
    <!-- Custom Tailwind config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'crowdvote': {
                            'blue': '#2563eb',
                            'purple': '#7c3aed',
                            'green': '#10b981',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Global Processing Indicator Styles -->
    <style>
        /* Simple div spinner - guaranteed to work */
        #processing-spinner.processing-active {
            animation: spin-simple 1s linear infinite !important;
            border-color: #2563eb !important; /* blue-600 */
            border-top-color: transparent !important;
        }

        #processing-spinner.processing-inactive {
            border-color: #9ca3af !important; /* gray-400 */
            border-top-color: transparent !important;
            animation: none !important;
        }

        @keyframes spin-simple {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Test class for debugging */
        .force-spin {
            animation: spin-simple 0.5s linear infinite !important;
            border-color: #ef4444 !important; /* red for testing */
            border-top-color: transparent !important;
        }
        
        /* Tooltip hover behavior - keep visible when hovering tooltip itself */
        #global-processing-indicator:hover #processing-tooltip,
        #processing-tooltip:hover {
            display: block !important;
        }
        
        /* Ensure tooltip stays visible during transition and has no gap */
        #processing-tooltip {
            transition: none !important;
            margin-top: 0 !important;
        }
        
        /* Ensure the invisible bridge works */
        #processing-tooltip .hover-bridge {
            pointer-events: auto;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    {% block page_layout %}
        <!-- Standard Application Layout -->
        <div class="{% block layout_classes %}lg:flex{% endblock %}">
            <!-- Sidebar Navigation (optional, can be overridden) -->
            {% block sidebar %}
                {% if user.is_authenticated %}
                    <!-- Default sidebar for authenticated users -->
                    <nav class="lg:w-80 lg:flex-shrink-0 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 lg:min-h-screen">
                        {% block sidebar_content %}
                            <!-- CrowdVote Logo Header -->
                            <div class="px-6 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-center h-16">
                                    {% load static %}
                                    <a href="{% url 'accounts:dashboard' %}" class="block">
                                        <img src="{% static 'logo.png' %}" alt="CrowdVote" class="h-14 w-auto">
                                    </a>
                                </div>
                            </div>
                        {% endblock sidebar_content %}
                    </nav>
                {% endif %}
            {% endblock sidebar %}

            <!-- Main Content Area -->
            <main class="flex-1 lg:pl-0">
                <!-- Top Header Navigation -->
                {% block header %}
                    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                        <div class="px-6">
                            <div class="flex justify-between items-center h-16">
                                <!-- Left side - Logo/Brand or Page Title -->
                                {% block header_left %}
                                <div class="flex items-center">
                                    {% load static %}
                                    {% if user.is_authenticated %}
                                        <!-- Logo links to dashboard when logged in -->
                                        <a href="{% url 'accounts:dashboard' %}" class="flex items-center">
                                            <img src="{% static 'logo.png' %}" alt="CrowdVote" class="h-8 w-auto">
                                        </a>
                                    {% else %}
                                        <!-- Logo links to landing page when not logged in -->
                                        <a href="/" class="flex items-center">
                                            <img src="{% static 'logo.png' %}" alt="CrowdVote" class="h-8 w-auto">
                                        </a>
                                    {% endif %}
                                </div>
                                {% endblock header_left %}
                                
                                <!-- Right side - User menu and Theme toggle -->
                <div class="flex items-center space-x-4">
                    {% if user.is_authenticated %}
                        <!-- User Menu Dropdown -->
                                        <div class="relative" x-data="{ open: false }">
                                            <!-- Dropdown Trigger -->
                                            <button @click="open = !open" 
                                                    class="flex items-center space-x-2 text-sm rounded-full hover:bg-gray-50 dark:hover:bg-gray-700 p-2 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                                {% load member_tags %}
                                                {% user_avatar user 28 %}
                                                <span class="text-gray-700 dark:text-gray-300 font-medium">{{ user.get_display_name }}</span>
                                                <!-- Dropdown Arrow -->
                                                <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                            
                                            <!-- Dropdown Menu -->
                                            <div x-show="open" 
                                                 @click.away="open = false"
                                                 x-transition:enter="transition ease-out duration-100"
                                                 x-transition:enter-start="transform opacity-0 scale-95"
                                                 x-transition:enter-end="transform opacity-100 scale-100"
                                                 x-transition:leave="transition ease-in duration-75"
                                                 x-transition:leave-start="transform opacity-100 scale-100"
                                                 x-transition:leave-end="transform opacity-0 scale-95"
                                                 class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-gray-200 dark:ring-gray-700 z-50">
                                                <div class="py-1">
                                                    <!-- Dashboard Link -->
                                                    <a href="{% url 'accounts:dashboard' %}" 
                                                       class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2v0zm0 0V5a2 2 0 012-2h6l2 2h6a2 2 0 012 2v0M7 13h10"></path>
                                                        </svg>
                                                        Dashboard
                                                    </a>
                                                    
                                                    <!-- Profile Link -->
                                                    <a href="{% url 'accounts:member_profile' user.username %}" 
                                                       class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                        </svg>
                                                        Profile
                                                    </a>
                                                    
                                                    <!-- Documentation Link -->
                                                    <a href="{% url 'docs' %}" 
                                                       class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                                        </svg>
                                                        Documentation
                                                    </a>
                                                    
                                                    <!-- Logout Link -->
                                                    <a href="{% url 'account_logout' %}" 
                                                       class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors border-t border-gray-200 dark:border-gray-600">
                                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                                        </svg>
                                                        Logout
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                        
                        <!-- Global Processing Indicator -->
                        {% if user.is_authenticated and request.resolver_match.url_name != 'home' %}
                        <div class="relative" id="global-processing-indicator">
                            <!-- Always-present icon (grayed out when inactive) -->
                            <div class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-help"
                                 id="processing-icon-container">
                                <!-- Simple spinning div that will definitely work -->
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 border-t-transparent processing-inactive" id="processing-spinner"></div>
                            </div>
                            
                            <!-- Hover tooltip (positioned absolutely with no gap) -->
                            <div class="absolute right-0 top-full w-80 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-gray-200 dark:ring-gray-700 z-50 hidden"
                                 id="processing-tooltip">
                                <!-- Invisible bridge to prevent hover gaps -->
                                <div class="absolute -top-1 right-0 w-full h-1 bg-transparent"></div>
                                
                                <!-- Tooltip content populated by JavaScript -->
                                <div class="p-3 text-sm text-gray-600 dark:text-gray-400" id="tooltip-content">
                                    No calculations running. When decisions are being processed, you'll see an active spinner here with links to those decisions and recent activity.
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Django Admin Style Theme Toggle -->
                        <button id="theme-toggle" 
                                class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                title="Toggle theme">
                            <!-- Sun icon (light mode) -->
                            <svg id="theme-icon-light" class="w-5 h-5 text-gray-600 dark:text-gray-400 hidden" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                            </svg>
                            <!-- Moon icon (dark mode) -->
                            <svg id="theme-icon-dark" class="w-5 h-5 text-gray-600 dark:text-gray-400 hidden" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                            </svg>
                            <!-- Half circle icon (system mode) -->
                            <svg id="theme-icon-system" class="w-5 h-5 text-gray-600 dark:text-gray-400 hidden" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8V2z"></path>
                            </svg>
                        </button>
                    {% endif %}
                </div>
                            </div>
                        </div>
                    </header>
                {% endblock header %}
                
                <!-- Page Content -->
                {% block content %}
                {% endblock %}
            </main>
        </div>
    {% endblock page_layout %}
    
    <!-- Global Theme Management Script -->
    <script>
        // Theme Management System
        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme(theme);
            updateThemeButtons(theme);
        }
        
        function applyTheme(theme) {
            const root = document.documentElement;
            
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                root.classList.add('dark');
            } else {
                root.classList.remove('dark');
            }
        }
        
        function updateThemeButtons(activeTheme) {
            const buttons = {
                light: document.querySelector('.light-theme-btn'),
                dark: document.querySelector('.dark-theme-btn'),
                system: document.querySelector('.system-theme-btn')
            };
            
            Object.keys(buttons).forEach(theme => {
                const btn = buttons[theme];
                if (btn && theme === activeTheme) {
                    btn.className = btn.className.replace(/text-gray-\d+/g, 'text-gray-900 dark:text-white').replace(/hover:text-gray-\d+/g, '') + ' bg-white dark:bg-gray-600 shadow-sm';
                } else if (btn) {
                    btn.className = btn.className.replace(/bg-white|bg-gray-600|shadow-sm/g, '').replace(/text-gray-900|dark:text-white/g, 'text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white');
                }
            });
        }
        
        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            updateThemeButtons(savedTheme);
            
            // Initialize Django Admin Style Theme Toggle
            initializeThemeToggle();
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const currentTheme = localStorage.getItem('theme');
                if (currentTheme === 'system') {
                    applyTheme('system');
                }
            });
        });
        
        // Django Admin Style Theme Toggle
        function initializeThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            const systemIcon = document.getElementById('theme-icon-system');
            
            if (!themeToggle) return; // Exit if theme toggle not present on page
            
            // Theme cycle: light -> dark -> system -> light
            const themes = ['light', 'dark', 'system'];
            let currentThemeIndex = 0;
            
            // Initialize theme from localStorage or default to light
            const savedTheme = localStorage.getItem('theme') || 'light';
            currentThemeIndex = themes.indexOf(savedTheme);
            if (currentThemeIndex === -1) currentThemeIndex = 0;
            
            // Apply theme and update icon
            function updateThemeToggle(theme) {
                // Hide all icons
                lightIcon.classList.add('hidden');
                darkIcon.classList.add('hidden');
                systemIcon.classList.add('hidden');
                
                // Show appropriate icon
                if (theme === 'light') {
                    lightIcon.classList.remove('hidden');
                } else if (theme === 'dark') {
                    darkIcon.classList.remove('hidden');
                } else {
                    systemIcon.classList.remove('hidden');
                }
                
                // Apply theme to document
                const root = document.documentElement;
                if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
                
                // Save to localStorage
                localStorage.setItem('theme', theme);
            }
            
            // Initialize on page load
            updateThemeToggle(themes[currentThemeIndex]);
            
            // Handle click to cycle through themes
            themeToggle.addEventListener('click', function() {
                currentThemeIndex = (currentThemeIndex + 1) % themes.length;
                updateThemeToggle(themes[currentThemeIndex]);
            });
            
            // Listen for system theme changes when in system mode
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if (themes[currentThemeIndex] === 'system') {
                    updateThemeToggle('system');
                }
            });
        }
    </script>
    
    <!-- Global Processing Indicator JavaScript -->
    {% if user.is_authenticated and request.resolver_match.url_name != 'home' %}
    <script>
        // Global Processing Indicator Management
        let pollingTimeout = null;
        let isPolling = false;
        let consecutiveInactivePolls = 0;
        
        function pollGlobalStatus() {
            if (isPolling) {
                return; // Prevent multiple simultaneous polls
            }
            
            isPolling = true;
            
            // Clear any existing timeout
            if (pollingTimeout) {
                clearTimeout(pollingTimeout);
                pollingTimeout = null;
            }
            
            fetch('/status/global-calculations/')
                .then(response => response.json())
                .then(data => {
                    updateProcessingIndicator(data);
                    
                    // Always reset polling state first
                    isPolling = false;
                    
                    if (data.has_active_calculations) {
                        // Continue polling every 3 seconds for active processing
                        consecutiveInactivePolls = 0;
                        pollingTimeout = setTimeout(() => {
                            pollingTimeout = null;
                            pollGlobalStatus();
                        }, 3000);
                    } else if (data.has_recent_activity) {
                        // Poll less frequently for recent activity only (every 30 seconds)
                        consecutiveInactivePolls++;
                        if (consecutiveInactivePolls < 3) { // Poll for up to 90 seconds after activity stops
                            pollingTimeout = setTimeout(() => {
                                pollingTimeout = null;
                                pollGlobalStatus();
                            }, 30000);
                        } else {
                            // Stop polling, but resume on user activity
                            setupActivityListener();
                        }
                    } else {
                        // Stop polling, but resume on user activity
                        setupActivityListener();
                    }
                })
                .catch(error => {
                    console.error('Error fetching global status:', error);
                    // Always reset polling state on error
                    isPolling = false;
                    // Retry after 5 seconds on error (shorter retry)
                    pollingTimeout = setTimeout(() => {
                        pollingTimeout = null;
                        pollGlobalStatus();
                    }, 5000);
                });
        }
        
        function updateProcessingIndicator(data) {
            const spinner = document.getElementById('processing-spinner');
            const tooltipContent = document.getElementById('tooltip-content');
            
            if (!spinner || !tooltipContent) return;
            
            if (data.has_active_calculations) {
                // Blue spinning icon for active processing
                spinner.className = 'w-5 h-5 rounded-full border-2 processing-active';
                // Force inline styles as backup
                spinner.style.borderColor = '#2563eb';
                spinner.style.borderTopColor = 'transparent';
                spinner.style.animation = 'spin-simple 1s linear infinite';
                populateActiveTooltip(data.decisions, tooltipContent);
            } else if (data.has_recent_activity) {
                // Gray static icon for recent activity only
                spinner.className = 'w-5 h-5 rounded-full border-2 processing-inactive';
                // Force inline styles as backup
                spinner.style.borderColor = '#9ca3af';
                spinner.style.borderTopColor = 'transparent';
                spinner.style.animation = 'none';
                populateRecentActivityTooltip(data.decisions, tooltipContent);
            } else {
                // Gray static icon for completely inactive
                spinner.className = 'w-5 h-5 rounded-full border-2 processing-inactive';
                // Force inline styles as backup
                spinner.style.borderColor = '#9ca3af';
                spinner.style.borderTopColor = 'transparent';
                spinner.style.animation = 'none';
                populateInactiveTooltip(tooltipContent);
            }
        }
        
        function populateActiveTooltip(decisions, tooltipContent) {
            const activeDecisions = decisions.filter(d => d.status_type === 'active');
            const recentDecisions = decisions.filter(d => d.status_type !== 'active');
            
            let html = '<div class="p-3">';
            
            // Active Processing Section
            if (activeDecisions.length > 0) {
                html += '<div class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-2">ðŸ”„ Currently Processing:</div>';
                html += '<div class="space-y-2 mb-4">';
                
                activeDecisions.forEach(decision => {
                    html += `
                        <a href="${decision.url}" 
                           class="block p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700">
                            <div class="text-sm font-medium text-blue-600 dark:text-blue-400">
                                ${escapeHtml(decision.title)}
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                ${escapeHtml(decision.community_name)} â€¢ ${escapeHtml(decision.status)}
                            </div>
                        </a>
                    `;
                });
                
                html += '</div>';
            }
            
            // Recent Activity Section
            if (recentDecisions.length > 0) {
                html += '<div class="border-t border-gray-200 dark:border-gray-600 pt-3">';
                html += '<div class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-2">ðŸ“‹ Recent Activity (24h):</div>';
                html += '<div class="space-y-2">';
                
                recentDecisions.forEach(decision => {
                    const colorClass = decision.status_type === 'completed' ? 
                        'text-green-600 dark:text-green-400' : 
                        'text-red-600 dark:text-red-400';
                    
                    html += `
                        <a href="${decision.url}" 
                           class="block p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700">
                            <div class="text-sm font-medium ${colorClass}">
                                ${escapeHtml(decision.title)}
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                ${escapeHtml(decision.community_name)} â€¢ ${escapeHtml(decision.status)}
                            </div>
                        </a>
                    `;
                });
                
                html += '</div></div>';
            }
            
            html += '</div>';
            tooltipContent.innerHTML = html;
        }
        
        function populateRecentActivityTooltip(decisions, tooltipContent) {
            let html = '<div class="p-3">';
            html += '<div class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-2">ðŸ“‹ Recent Activity (24h):</div>';
            html += '<div class="space-y-2">';
            
            decisions.forEach(decision => {
                const colorClass = decision.status_type === 'completed' ? 
                    'text-green-600 dark:text-green-400' : 
                    'text-red-600 dark:text-red-400';
                
                html += `
                    <a href="${decision.url}" 
                       class="block p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700">
                        <div class="text-sm font-medium ${colorClass}">
                            ${escapeHtml(decision.title)}
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            ${escapeHtml(decision.community_name)} â€¢ ${escapeHtml(decision.status)}
                        </div>
                    </a>
                `;
            });
            
            html += '</div></div>';
            tooltipContent.innerHTML = html;
        }
        
        function populateInactiveTooltip(tooltipContent) {
            tooltipContent.innerHTML = `
                <div class="p-3 text-sm text-gray-600 dark:text-gray-400">
                    No calculations running. When decisions are being processed, you'll see an active spinner here with links to those decisions and recent activity.
                </div>
            `;
        }
        
        function setupActivityListener() {
            let activityTimer = null;
            
            function onUserActivity() {
                if (activityTimer) clearTimeout(activityTimer);
                
                activityTimer = setTimeout(() => {
                    if (!isPolling && !pollingTimeout) {
                        pollGlobalStatus();
                    }
                }, 1000); // Debounce activity detection
            }
            
            // Listen for user activity
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, onUserActivity, { once: true, passive: true });
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize polling when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Start initial poll
            pollGlobalStatus();
            
            // Poll regularly to catch user actions
            const constantPollInterval = setInterval(() => {
                if (!isPolling && !pollingTimeout) {
                    pollGlobalStatus();
                }
            }, 5000); // Poll every 5 seconds
            
            // Enhanced tooltip hover management
            const indicator = document.getElementById('global-processing-indicator');
            const tooltip = document.getElementById('processing-tooltip');
            let hoverTimeout = null;
            
            if (indicator && tooltip) {
                // Show tooltip on hover
                indicator.addEventListener('mouseenter', function() {
                    if (hoverTimeout) {
                        clearTimeout(hoverTimeout);
                        hoverTimeout = null;
                    }
                    tooltip.classList.remove('hidden');
                });
                
                // Keep tooltip visible when hovering over tooltip itself
                tooltip.addEventListener('mouseenter', function() {
                    if (hoverTimeout) {
                        clearTimeout(hoverTimeout);
                        hoverTimeout = null;
                    }
                    tooltip.classList.remove('hidden');
                });
                
                // Hide tooltip with delay when leaving indicator
                indicator.addEventListener('mouseleave', function() {
                    hoverTimeout = setTimeout(() => {
                        tooltip.classList.add('hidden');
                    }, 100); // 100ms delay to allow moving to tooltip
                });
                
                // Hide tooltip when leaving tooltip
                tooltip.addEventListener('mouseleave', function() {
                    hoverTimeout = setTimeout(() => {
                        tooltip.classList.add('hidden');
                    }, 100); // 100ms delay
                });
            }
            
            // Clean up interval on page unload
            window.addEventListener('beforeunload', function() {
                clearInterval(constantPollInterval);
            });
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (pollingTimeout) {
                clearTimeout(pollingTimeout);
            }
        });
    </script>
    {% endif %}
    
    <!-- Page-specific scripts -->
    {% block scripts %}
    {% endblock scripts %}
</body>
</html>
