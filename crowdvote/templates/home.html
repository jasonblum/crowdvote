{% extends "base.html" %}
{% load static %}

{% block title %}CrowdVote - A Platform for Free Market Representation{% endblock %}

{% block header %}
<!-- Home page has its own header design, so we override the base header -->
{% endblock %}

{% block content %}
<!-- Beta Alert Banner -->
<div id="beta-banner" class="bg-blue-600 transition-opacity duration-1000">
  <div class="mx-auto max-w-7xl px-3 py-3 sm:px-6 lg:px-8">
    <div class="flex flex-wrap items-center justify-between">
      <div class="flex w-0 flex-1 items-center">
        <span class="flex rounded-lg bg-blue-800 p-2">
          <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
        </span>
        <p class="ml-3 font-medium text-white">
          <span class="md:hidden">Hey! This application is in Beta - still under construction but feel free to login and poke around!<br>Please send feedback to <a href="mailto:support@crowdvote.com" class="underline hover:text-blue-200">support@crowdvote.com</a>.</span>
          <span class="hidden md:inline">Hey! This application is in Beta - still under construction but feel free to login and poke around!<br>Please send feedback to <a href="mailto:support@crowdvote.com" class="underline hover:text-blue-200">support@crowdvote.com</a> or <a href="{% url 'docs' %}" class="underline hover:text-blue-200">check out the docs</a>.</span>
        </p>
      </div>
      <div class="order-3 mt-2 w-full flex-shrink-0 sm:order-2 sm:mt-0 sm:w-auto">
        <a href="{% url 'docs' %}" class="flex items-center justify-center rounded-md border border-transparent bg-white px-4 py-2 text-sm font-medium text-blue-600 shadow-sm hover:bg-blue-50 sm:hidden">Learn more</a>
      </div>
      <div class="order-2 flex-shrink-0 sm:order-3 sm:ml-3">
        <button type="button" onclick="this.closest('.bg-blue-600').style.display='none'" class="-mr-1 flex rounded-md p-2 hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-white sm:-mr-2">
          <span class="sr-only">Dismiss</span>
          <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="relative h-screen overflow-hidden">
  <!-- Ken Burns Background -->
  <div class="absolute inset-0 ken-burns-bg" style="background-image: url('{% static 'crowd.jpg' %}'); background-size: 100% 100%; background-position: center center; background-repeat: no-repeat;"></div>
  <!-- Dark overlay for better text readability -->
  <div class="absolute inset-0 bg-black bg-opacity-50"></div>
  
  <!-- Header with Docs link and Theme switcher -->
  <header class="absolute inset-x-0 top-0 z-50">
    <nav aria-label="Global" class="flex items-center justify-between p-6 lg:px-8">
      <!-- Left side - empty for home page -->
      <div></div>
      
      <!-- Right side - Docs link only -->
      <div class="flex items-center">
        <!-- Docs Link -->
        <a href="{% url 'docs' %}" class="text-6xl/6 font-semibold text-white hover:text-gray-300 transition-colors">
          ?! <span aria-hidden="true">→</span>
        </a>
      </div>
    </nav>
  </header>

  <!-- Hero Content -->
  <div class="relative isolate px-6 pt-20 lg:px-8 min-h-screen flex items-center">
    <div class="mx-auto max-w-2xl w-full">
      <div class="text-center">
        <!-- White Background Container -->
        <div class="bg-green-50/80 backdrop-blur-sm rounded-2xl shadow-2xl px-6 py-6 sm:px-9 sm:py-8 mx-auto max-w-lg">
          <!-- CrowdVote Logo -->
          <div class="mb-2">
            <img src="{% static 'logo.png' %}" alt="CrowdVote" class="mx-auto h-20 sm:h-24 lg:h-28 w-auto">
          </div>
          <p class="mt-2 text-lg font-medium text-pretty text-gray-800 sm:text-xl/8">
            <i>Real</i> Democracy happens between elections
          </p>
          
          <!-- Email Signup Form -->
          <div class="mt-8 mx-auto max-w-md">
          <!-- Messages Display -->
          {% if messages %}
              <div class="mb-6 space-y-3">
                  {% for message in messages %}
                      {% if message.tags == 'success' %}
                          <div class="bg-green-50/80 border border-green-200 rounded-lg p-4 text-green-800">
                              <div class="flex">
                                  <span class="text-green-500 mr-3">✉️</span>
                                  <div>
                                      <p class="font-medium">{{ message }}</p>
                                      <p class="text-sm text-green-600 mt-1">
                                          Check your email (including spam/junk folder) and click the link to sign in instantly!
                                      </p>
                                  </div>
                              </div>
                          </div>
                      {% elif message.tags == 'error' %}
                          <div class="rounded-md bg-green-50/80 p-4">
                              <div class="flex">
                                  <div class="flex-shrink-0">
                                      <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                                      </svg>
                                  </div>
                                  <div class="ml-3">
                                      <h3 class="text-sm font-medium text-red-800">
                                          Email service issue
                                      </h3>
                                      <div class="mt-2 text-sm text-red-700">
                                          {% if 'safe' in message.extra_tags %}
                                              <p>{{ message|safe }}</p>
                                          {% else %}
                                              <p>{{ message }}</p>
                                          {% endif %}
                                      </div>
                                  </div>
                              </div>
                          </div>
                      {% else %}
                          <div class="rounded-md bg-green-50/80 p-4">
                              <div class="flex">
                                  <div class="flex-shrink-0">
                                      <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
                                      </svg>
                                  </div>
                                  <div class="ml-3">
                                      <h3 class="text-sm font-medium text-blue-800">
                                          Information
                                      </h3>
                                      <div class="mt-2 text-sm text-blue-700">
                                          <p>{{ message }}</p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      {% endif %}
                  {% endfor %}
              </div>
          {% endif %}
          
          <form method="post" action="{% url 'accounts:request_magic_link' %}" class="space-y-4" id="magic-link-form">
              {% csrf_token %}
              <div>
                  <input type="email" 
                         name="email" 
                         placeholder="your.email@example.com"
                         required
                         class="mx-auto block w-80 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-lg bg-white bg-opacity-95">
              </div>
              
              <!-- Turnstile CAPTCHA Widget -->
              {% if TURNSTILE_SITE_KEY %}
              <div class="cf-turnstile mx-auto" 
                   data-sitekey="{{ TURNSTILE_SITE_KEY }}" 
                   data-callback="onTurnstileSuccess"
                   data-error-callback="onTurnstileError"
                   data-theme="light"
                   data-size="normal">
              </div>
              <input type="hidden" name="captcha_token" id="captcha-token">
              {% endif %}
              
              <button type="submit" 
                      class="mx-auto block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                  Send Magic Link to log in! ✨
              </button>
          </form>
          
        </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Animated Speech Bubbles -->
  <div id="speech-bubbles" class="fixed inset-0 pointer-events-none z-10">
    <!-- Bubbles will be dynamically inserted here -->
  </div>
</div>

<style>
/* Ken Burns Effect for Background */
.ken-burns-bg {
  animation: kenBurns 120s ease-in-out infinite alternate;
  transform-origin: center;
}

@keyframes kenBurns {
  0% {
    transform: scale(1.05) translate(0%, 0%);
  }
  20% {
    transform: scale(1.08) translate(-2%, -3%);
  }
  40% {
    transform: scale(1.06) translate(3%, 2%);
  }
  60% {
    transform: scale(1.1) translate(-1%, 3%);
  }
  80% {
    transform: scale(1.04) translate(2%, -2%);
  }
  100% {
    transform: scale(1.08) translate(-3%, -4%);
  }
}

.speech-bubble {
  position: absolute;
  background: #f0fdf4;
  border-radius: 15px;
  padding: 10px 14px;
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  max-width: 200px;
  text-align: center;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.5s ease;
  z-index: 10;
  line-height: 1.3;
}

/* Bubble tail styles for different directions */
.speech-bubble.tail-bottom::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-top: 8px solid #f0fdf4;
}

.speech-bubble.tail-bottom-left::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 20%;
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-top: 8px solid #f0fdf4;
}

.speech-bubble.tail-bottom-right::after {
  content: '';
  position: absolute;
  bottom: -8px;
  right: 20%;
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-top: 8px solid #f0fdf4;
}

.speech-bubble.tail-top::after {
  content: '';
  position: absolute;
  top: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-bottom: 8px solid #f0fdf4;
}

.speech-bubble.tail-top-left::after {
  content: '';
  position: absolute;
  top: -8px;
  left: 20%;
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-bottom: 8px solid #f0fdf4;
}

.speech-bubble.tail-top-right::after {
  content: '';
  position: absolute;
  top: -8px;
  right: 20%;
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-bottom: 8px solid #f0fdf4;
}

.speech-bubble.show {
  opacity: 1;
  transform: translateY(0);
}

@media (max-width: 640px) {
  .speech-bubble {
    font-size: 16px;
    padding: 8px 12px;
    max-width: 160px;
  }
}
</style>

<!-- Turnstile CAPTCHA Script -->
{% if TURNSTILE_SITE_KEY %}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
{% endif %}

<script>
// Turnstile CAPTCHA callbacks
{% if TURNSTILE_SITE_KEY %}
function onTurnstileSuccess(token) {
    document.getElementById('captcha-token').value = token;
}

function onTurnstileError() {
    console.error('Turnstile CAPTCHA error');
    document.getElementById('captcha-token').value = '';
}
{% endif %}

// Get slogans from Django context
const slogans = [
  {% for slogan in slogans %}
    "{{ slogan|escapejs }}"{% if not forloop.last %},{% endif %}
  {% endfor %}
];

const tailClasses = [
  'tail-bottom',
  'tail-bottom-left', 
  'tail-bottom-right',
  'tail-top',
  'tail-top-left',
  'tail-top-right'
];

function createSpeechBubble() {
  const container = document.getElementById('speech-bubbles');
  const bubble = document.createElement('div');
  
  // Random tail direction
  const randomTail = tailClasses[Math.floor(Math.random() * tailClasses.length)];
  bubble.className = `speech-bubble ${randomTail}`;
  
  // Random slogan
  const randomSlogan = slogans[Math.floor(Math.random() * slogans.length)];
  bubble.innerHTML = randomSlogan;
  
  // Safe positioning - avoid center area and edges
  const safeMargin = 20;
  const centerAvoidWidth = 600; // Avoid center area with content
  const centerAvoidHeight = 400;
  
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  let x, y;
  
  // Choose a safe area (left or right side, avoiding center)
  if (Math.random() > 0.5) {
    // Left side
    x = safeMargin + Math.random() * Math.max(50, (viewportWidth - centerAvoidWidth) / 2 - safeMargin);
  } else {
    // Right side
    x = (viewportWidth + centerAvoidWidth) / 2 + Math.random() * Math.max(50, (viewportWidth - centerAvoidWidth) / 2 - safeMargin);
  }
  
  // Vertical positioning - avoid center area
  if (Math.random() > 0.5) {
    // Top area
    y = safeMargin + Math.random() * Math.max(50, (viewportHeight - centerAvoidHeight) / 2 - safeMargin);
  } else {
    // Bottom area
    y = (viewportHeight + centerAvoidHeight) / 2 + Math.random() * Math.max(50, (viewportHeight - centerAvoidHeight) / 2 - safeMargin);
  }
  
  // Ensure bubble stays within viewport bounds
  x = Math.max(safeMargin, Math.min(x, viewportWidth - 220)); // 220 = max bubble width + margin
  y = Math.max(safeMargin, Math.min(y, viewportHeight - 80));  // 80 = bubble height + margin
  
  bubble.style.left = x + 'px';
  bubble.style.top = y + 'px';
  
  container.appendChild(bubble);
  
  // Animate in
  setTimeout(() => {
    bubble.classList.add('show');
  }, 100);
  
  // Remove after showing - randomize display time
  const displayTime = 2500 + Math.random() * 2000; // 2.5-4.5 seconds
  setTimeout(() => {
    bubble.classList.remove('show');
    setTimeout(() => {
      if (bubble.parentNode) {
        bubble.parentNode.removeChild(bubble);
      }
    }, 500);
  }, displayTime);
}

// Start the animation cycle
function startSpeechBubbles() {
  // Create first bubble after a short delay
  setTimeout(createSpeechBubble, 1500 + Math.random() * 1000);
  
  // Schedule random bubbles with overlapping
  function scheduleNextBubble() {
    const nextDelay = 2000 + Math.random() * 4000; // 2-6 seconds between bubbles
    setTimeout(() => {
      createSpeechBubble();
      scheduleNextBubble(); // Schedule the next one
    }, nextDelay);
  }
  
  scheduleNextBubble();
}

// Start when page loads
document.addEventListener('DOMContentLoaded', startSpeechBubbles);

// Auto-hide beta banner after 20 seconds
document.addEventListener('DOMContentLoaded', function() {
  const banner = document.getElementById('beta-banner');
  if (banner) {
    setTimeout(function() {
      // Simulate clicking the X button
      const closeButton = banner.querySelector('button[onclick*="display=\'none\'"]');
      if (closeButton) {
        closeButton.click();
      }
    }, 30000); // 30 seconds
  }
});
</script>

{% endblock %}
