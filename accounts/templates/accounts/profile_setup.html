{% extends "base.html" %}

{% block title %}Complete Your Profile - CrowdVote{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 py-12">
    <div class="max-w-2xl mx-auto px-6">
        <!-- Progress Indicator -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center space-x-4 mb-4">
                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-semibold">‚úì</div>
                <div class="w-16 h-1 bg-green-500"></div>
                <div class="w-8 h-8 bg-crowdvote-blue rounded-full flex items-center justify-center text-white font-semibold">2</div>
                <div class="w-16 h-1 bg-gray-300"></div>
                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-semibold">3</div>
            </div>
            <p class="text-gray-600">Email Verified ‚Üí <strong>Profile Setup</strong> ‚Üí Community Selection</p>
        </div>

        <!-- Profile Setup Form -->
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-blue-200">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    Welcome to CrowdVote! üéâ
                </h1>
                <p class="text-gray-600">
                    Let's set up your profile so you can start participating in democracy
                </p>
            </div>

            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Name Fields -->
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">
                            First Name *
                        </label>
                        <input type="text" 
                               id="first_name" 
                               name="first_name" 
                               value="{{ user.first_name }}"
                               required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-crowdvote-blue focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">
                            Last Name
                        </label>
                        <input type="text" 
                               id="last_name" 
                               name="last_name" 
                               value="{{ user.last_name }}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-crowdvote-blue focus:border-transparent transition-all duration-200">
                    </div>
                </div>

                <!-- Username Section -->
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                        Choose Your Username *
                    </label>
                    <p class="text-sm text-gray-500 mb-3">
                        This is how other community members will see you. You can use the suggested one or create your own.
                    </p>
                    
                    <div class="space-y-3">
                        <!-- Username Input with Live Validation -->
                        <div class="flex space-x-2">
                            <input type="text" 
                                   id="username" 
                                   name="username" 
                                   value="{{ suggested_username }}"
                                   required
                                   hx-post="{% url 'accounts:check_username' %}"
                                   hx-trigger="keyup changed delay:500ms"
                                   hx-target="#username-feedback"
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-crowdvote-blue focus:border-transparent transition-all duration-200">
                            
                            <button type="button"
                                    hx-post="{% url 'accounts:generate_username' %}"
                                    hx-target="#username-input"
                                    hx-swap="outerHTML"
                                    class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-all duration-200 whitespace-nowrap">
                                üé≤ New One
                            </button>
                        </div>
                        
                        <!-- Real-time Username Feedback -->
                        <div id="username-feedback" class="text-sm">
                            <span class="text-blue-600">‚ú® How about "{{ suggested_username }}"?</span>
                        </div>
                    </div>
                </div>

                <!-- Username Guidelines -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="font-medium text-crowdvote-blue mb-2">Username Guidelines:</h4>
                    <ul class="text-sm text-gray-700 space-y-1">
                        <li>‚Ä¢ 3-30 characters long</li>
                        <li>‚Ä¢ Letters and numbers only</li>
                        <li>‚Ä¢ Make it memorable - this is how activists build their reputation!</li>
                    </ul>
                </div>

                <!-- Democracy Motivation -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6">
                    <h3 class="font-semibold text-gray-800 mb-2">üó≥Ô∏è Ready to Shape Democracy?</h3>
                    <p class="text-gray-700 text-sm">
                        As <strong>{{ suggested_username }}</strong>, you'll be able to vote directly on community decisions 
                        or delegate your voting power to trusted experts on specific topics. Build influence through expertise, 
                        not campaign contributions.
                    </p>
                </div>

                <!-- Submit Button -->
                <button type="submit" 
                        class="w-full bg-crowdvote-blue hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                    Complete Profile & Continue üöÄ
                </button>
            </form>
        </div>

        <!-- Skip Option -->
        <div class="text-center mt-6">
            <p class="text-gray-500 text-sm">
                Want to explore first? 
                <a href="{% url 'accounts:community_discovery' %}" class="text-crowdvote-blue hover:underline">
                    Browse communities without completing profile
                </a>
            </p>
        </div>
    </div>
</div>

<!-- HTMX Username Replacement Script -->
<script>
    // Handle username generation response
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.xhr.responseURL.includes('generate-username')) {
            const response = JSON.parse(event.detail.xhr.responseText);
            if (response.username) {
                document.getElementById('username').value = response.username;
                document.getElementById('username-feedback').innerHTML = 
                    `<span class="${response.class}">${response.message}</span>`;
            }
        }
    });
</script>
{% endblock %}
