{% extends "base.html" %}
{% load member_tags %}

{% block title %}{{ decision.title }} - {{ community.name }} - CrowdVote{% endblock %}

{% block sidebar_content %}
    <!-- Decision Sidebar Navigation -->
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-sm">üó≥Ô∏è</span>
                </div>
            </div>
            <div class="ml-3">
                <h1 class="text-lg font-medium text-gray-900 dark:text-white">Decision Details</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">{{ community.name }}</p>
            </div>
        </div>
    </div>
    
    <!-- Navigation Menu -->
    <div class="px-6 py-4">
        <nav class="space-y-2">
            <a href="#decision-info" class="flex items-center px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 dark:bg-blue-900/20 rounded-md">
                üìã Decision Info
            </a>
            {% if can_vote %}
                <a href="#voting-section" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md">
                    üó≥Ô∏è Cast Your Vote
                </a>
            {% endif %}
            {% if current_results or status == 'closed' %}
                <a href="#results-section" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md">
                    üìä Current Results
                </a>
            {% endif %}
        </nav>
    </div>
    
    <!-- Decision Results Panel -->
    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
        <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-green-900 dark:text-green-100">üìä Live Results</h3>
                {% if status == 'active' %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100">
                        üü¢ Live
                    </span>
                {% elif status == 'closed' %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                        üîí Final
                    </span>
                {% endif %}
            </div>
            
            <!-- Countdown Timer or Status -->
            {% if status == 'active' and decision.dt_close %}
                <div class="mb-3 p-2 bg-white dark:bg-gray-800 rounded border border-green-200 dark:border-green-600">
                    <div class="text-xs text-green-700 dark:text-green-300 font-medium mb-1">Voting closes in:</div>
                    <div id="countdown-timer" 
                         class="text-sm font-bold text-green-900 dark:text-green-100" 
                         data-deadline="{{ decision.dt_close|date:'c' }}">
                        Calculating...
                    </div>
                </div>
            {% endif %}
            
            <!-- Quick Stats -->
            <div class="space-y-2 text-xs">
                <div class="flex items-center justify-between">
                    <span class="text-green-700 dark:text-green-300">Participation</span>
                    <span class="font-semibold text-green-900 dark:text-green-100">
                        {{ stats.total_ballots }}/{{ stats.voting_members }} 
                        ({{ stats.participation_rate }}%)
                    </span>
                </div>
            </div>
            
            <!-- View Complete Results Link -->
            <div class="pt-3 border-t border-green-200 dark:border-green-600 mt-3">
                <a href="{% url 'democracy:decision_results' community.id decision.id %}" 
                   class="inline-flex items-center justify-center w-full px-3 py-2 border border-green-300 dark:border-green-600 text-xs font-medium rounded-md text-green-700 dark:text-green-300 bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-900/30 transition-colors">
                    üìã Complete Results & Analysis
                </a>
            </div>
        </div>
    </div>
    
    <!-- Back to Community -->
    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
        <a href="{% url 'democracy:decision_list' community.id %}" 
           class="flex items-center justify-center w-full px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
            ‚Üê Back to Decisions
        </a>
    </div>
    
    <!-- Theme Toggle -->
    {% block theme_toggle %}
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Theme:</span>
                <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                    <button type="button" onclick="setTheme('light')" class="px-2 py-1 text-xs font-medium rounded-md transition-colors light-theme-btn">
                        Light
                    </button>
                    <button type="button" onclick="setTheme('dark')" class="px-2 py-1 text-xs font-medium rounded-md transition-colors dark-theme-btn">
                        Dark
                    </button>
                    <button type="button" onclick="setTheme('system')" class="px-2 py-1 text-xs font-medium rounded-md transition-colors system-theme-btn">
                        Auto
                    </button>
                </div>
            </div>
        </div>
    {% endblock %}
{% endblock sidebar_content %}

{% block content %}
    <!-- Page Content -->
    <div class="max-w-4xl mx-auto py-8 px-6">
        <div class="space-y-8">
            <!-- Section 1: Decision Header & Details -->
            <section id="decision-info" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
                <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center space-x-3 mb-2">
                                {% if status == 'active' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200">
                                        üü¢ Active - Voting Open
                                    </span>
                                {% elif status == 'closed' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                                        üî¥ Closed - Results Final
                                    </span>
                                {% elif status == 'draft' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200">
                                        ‚ö™ Draft - Not Published
                                    </span>
                                {% endif %}
                                
                                {% if decision.dt_close %}
                                    <span class="text-sm text-gray-500 dark:text-gray-400">
                                        {% if status == 'active' %}
                                            Voting closes {{ decision.dt_close|date:"M j, Y \a\t g:i A" }}
                                        {% else %}
                                            Voting closed {{ decision.dt_close|date:"M j, Y \a\t g:i A" }}
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </div>
                            
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ decision.title }}</h1>
                            <p class="mt-1 text-gray-600 dark:text-gray-400">{{ community.name }}</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            {% if can_edit %}
                                <a href="{% url 'democracy:decision_edit' community.id decision.id %}" 
                                   class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 font-medium transition-colors">
                                    ‚úèÔ∏è Edit
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="px-6 py-6">
                    <div class="prose prose-gray dark:prose-invert max-w-none">
                        <p class="text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line">{{ decision.description }}</p>
                    </div>
                </div>
            </section>

            <!-- Voting Interface -->
            {% if can_vote %}
                <section id="voting-section" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
                    <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-lg font-medium text-gray-900 dark:text-white">üó≥Ô∏è Cast Your Vote</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Use STAR voting to rate each choice from 0-5 stars</p>
                            </div>
                            {% if user_ballot %}
                                <span class="text-sm text-blue-600 dark:text-blue-400 font-medium">‚úì Vote cast - you can update anytime before deadline</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="px-6 py-6">
                    
                    <form method="post" id="vote-form" action="{% url 'democracy:vote_submit' community.id decision.id %}">
                        {% csrf_token %}
                        
                        <!-- Choices with Star Rating -->
                        <div class="space-y-6 mb-8">
                            {% for choice in decision.choices.all %}
                                <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-6 bg-gray-50 dark:bg-gray-700/50">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex-1">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">{{ choice.title }}</h3>
                                            {% if choice.description %}
                                                <p class="text-gray-600 dark:text-gray-400 text-sm">{{ choice.description }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Star Rating Interface -->
                                    <div class="flex items-center space-x-4">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Your rating:</span>
                                        <div class="flex items-center space-x-1 star-rating" data-choice-id="{{ choice.id }}">
                                            {% for star in "12345" %}
                                                <button type="button" 
                                                        class="star text-3xl text-gray-300 dark:text-gray-600 hover:text-yellow-400 transition-colors focus:outline-none"
                                                        data-rating="{{ star }}"
                                                        title="{{ star }} star{{ star|pluralize }}">
                                                    ‚òÜ
                                                </button>
                                            {% endfor %}
                                            <span class="ml-3 text-sm text-gray-600 dark:text-gray-400 rating-text">0 stars - No rating</span>
                                        </div>
                                        <input type="hidden" name="choice_{{ choice.id }}" value="0" class="rating-input">
                                    </div>
                                    
                                    <!-- Rating Labels -->
                                    <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                                        <div class="flex justify-between">
                                            <span>0 = No preference</span>
                                            <span>1 = Strongly oppose</span>
                                            <span>2 = Oppose</span>
                                            <span>3 = Neutral</span>
                                            <span>4 = Support</span>
                                            <span>5 = Strongly support</span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Tags Input -->
                        <div class="mb-6">
                            <label for="tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Tags for this vote (optional)
                            </label>
                            <input type="text" 
                                   name="tags" 
                                   id="tags"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Add tags like 'budget, environment, maintenance' to help others follow your expertise"
                                   value="{% if user_ballot %}{{ user_ballot.tags }}{% endif %}">
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                Tags help other community members follow your expertise on specific topics for delegation.
                            </p>
                        </div>
                        
                        <!-- Anonymity Toggle -->
                        <div class="mb-6">
                            <div class="flex items-center">
                                <input type="checkbox" 
                                       name="is_anonymous" 
                                       id="is_anonymous"
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 rounded"
                                       {% if user_ballot.is_anonymous or user_membership.is_anonymous_by_default %}checked{% endif %}>
                                <label for="is_anonymous" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                                    Vote anonymously (your identity will be hidden in public results)
                                </label>
                            </div>
                        </div>
                        
                        <!-- Submit Button (Save Draft removed as requested) -->
                        <div class="flex items-center justify-between pt-6 border-t border-gray-200 dark:border-gray-600">
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                You can change your vote anytime before {{ decision.dt_close|date:"M j, Y \a\t g:i A" }}
                            </div>
                            <button type="submit" 
                                    id="submit-vote-btn"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 font-medium transition-colors">
                                {% if user_ballot %}Update Vote{% else %}Submit Vote{% endif %}
                            </button>
                        </div>
                    </form>
                    </div>
                </section>
            {% endif %}

            <!-- Current Results (if available) -->
            {% if current_results or status == 'closed' %}
                <section id="results-section" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
                    <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-lg font-medium text-gray-900 dark:text-white">
                            üìä {% if status == 'closed' %}Final Results{% else %}Current Results{% endif %}
                        </h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Live vote tallies and analysis</p>
                    </div>
                    <div class="px-6 py-6">
                        {% if current_results %}
                            <!-- Display results from the Result model -->
                            <div class="prose prose-gray dark:prose-invert max-w-none">
                                {{ current_results.report|linebreaks }}
                            </div>
                        {% else %}
                            <!-- Simple vote counts if no formal results yet -->
                            <div class="space-y-4">
                                {% for choice in decision.choices.all %}
                                    <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                                        <div>
                                            <h3 class="font-medium text-gray-900 dark:text-white">{{ choice.title }}</h3>
                                            {% if choice.description %}
                                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ choice.description }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                                {{ choice.get_vote_count }} vote{{ choice.get_vote_count|pluralize }}
                                            </div>
                                            {% if choice.get_average_stars %}
                                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                                    Avg: {{ choice.get_average_stars|floatformat:1 }} stars
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </section>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize star ratings
    const starRatings = document.querySelectorAll('.star-rating');
    
    starRatings.forEach(rating => {
        const stars = rating.querySelectorAll('.star');
        const ratingText = rating.querySelector('.rating-text');
        const hiddenInput = rating.parentElement.querySelector('.rating-input');
        const choiceId = rating.dataset.choiceId;
        
        // Set initial rating if user has already voted
        {% if user_ballot %}
            const existingVotes = {
                {% for vote in user_ballot.votes.all %}
                    "{{ vote.choice.id }}": {{ vote.stars }},
                {% endfor %}
            };
            
            if (existingVotes[choiceId]) {
                setRating(rating, existingVotes[choiceId]);
            }
        {% endif %}
        
        // Add click handlers
        stars.forEach((star, index) => {
            star.addEventListener('click', function() {
                const rating_value = index + 1;
                setRating(rating, rating_value);
            });
            
            // Hover effects
            star.addEventListener('mouseenter', function() {
                highlightStars(stars, index + 1);
            });
        });
        
        // Reset on mouse leave
        rating.addEventListener('mouseleave', function() {
            const currentRating = parseInt(hiddenInput.value) || 0;
            highlightStars(stars, currentRating);
        });
    });
    
    function setRating(ratingContainer, value) {
        const stars = ratingContainer.querySelectorAll('.star');
        const ratingText = ratingContainer.querySelector('.rating-text');
        const hiddenInput = ratingContainer.parentElement.querySelector('.rating-input');
        
        hiddenInput.value = value;
        highlightStars(stars, value);
        
        // Update text
        const labels = {
            0: '0 stars - No rating',
            1: '1 star - Strongly oppose',
            2: '2 stars - Oppose', 
            3: '3 stars - Neutral',
            4: '4 stars - Support',
            5: '5 stars - Strongly support'
        };
        ratingText.textContent = labels[value] || `${value} stars`;
    }
    
    function highlightStars(stars, count) {
        stars.forEach((star, index) => {
            if (index < count) {
                star.textContent = '‚òÖ';
                star.classList.add('text-yellow-400');
                star.classList.remove('text-gray-300');
            } else {
                star.textContent = '‚òÜ';
                star.classList.add('text-gray-300');
                star.classList.remove('text-yellow-400');
            }
        });
    }
    
    // Form validation
    document.getElementById('vote-form').addEventListener('submit', function(e) {
        const ratings = document.querySelectorAll('.rating-input');
        let hasRating = false;
        
        ratings.forEach(input => {
            if (parseInt(input.value) > 0) {
                hasRating = true;
            }
        });
        
        if (!hasRating) {
            e.preventDefault();
            alert('Please rate at least one choice with 1 or more stars before submitting your vote.');
            return;
        }
    });
    
    // Countdown Timer for Active Decisions
    const countdownElement = document.getElementById('countdown-timer');
    if (countdownElement) {
        const deadline = new Date(countdownElement.dataset.deadline);
        
        function updateCountdown() {
            const now = new Date();
            const timeLeft = deadline - now;
            
            if (timeLeft <= 0) {
                countdownElement.textContent = 'Voting has ended';
                countdownElement.className = countdownElement.className.replace('text-green-900', 'text-red-600');
                return;
            }
            
            // Calculate time components
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            // Format display - always include seconds for excitement!
            let display = '';
            if (days > 0) {
                display = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            } else if (hours > 0) {
                display = `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                display = `${minutes}m ${seconds}s`;
            } else {
                display = `${seconds}s`;
                // Add urgency styling for last minute
                if (seconds <= 60) {
                    countdownElement.className = countdownElement.className.replace('text-green-900', 'text-red-600');
                }
            }
            
            countdownElement.textContent = display;
        }
        
        // Update immediately and then every second
        updateCountdown();
        setInterval(updateCountdown, 1000);
    }
});
</script>
{% endblock scripts %}
