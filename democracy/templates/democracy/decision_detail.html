{% extends "base.html" %}
{% load member_tags %}

{% block title %}{{ decision.title }} - {{ community.name }} - CrowdVote{% endblock %}

{% block sidebar_content %}
    <!-- Inherit logo from base.html -->
    {{ block.super }}
    
    <!-- Decision Sidebar Navigation -->
    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-sm">üó≥Ô∏è</span>
                </div>
            </div>
            <div class="ml-3">
                <h1 class="text-lg font-medium text-gray-900 dark:text-white">Decision Details</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">{{ community.name }}</p>
            </div>
        </div>
    </div>
    
    <!-- Navigation Menu -->
    <div class="px-6 py-4">
        <nav class="space-y-2">
            <a href="#decision-info" class="flex items-center px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 dark:bg-blue-900/20 rounded-md">
                üìã Decision Info
            </a>
            {% if can_vote %}
                <a href="#voting-section" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md">
                    üó≥Ô∏è Cast Your Vote
                </a>
            {% endif %}
            {% if current_results or status == 'closed' %}
                <a href="#results-section" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md">
                    üìä Current Results
                </a>
            {% endif %}
            {% if snapshots.exists %}
                <a href="#snapshots-section" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md">
                    üì∏ Calculation History
                </a>
            {% endif %}
        </nav>
    </div>
    
    <!-- Quick Actions (Plan #8: Removed Live Results panel, kept link to results) -->
    {% if current_results or status == 'closed' or snapshots.exists %}
    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
        <a href="#snapshots-section" 
           class="flex items-center justify-center w-full px-4 py-2 border border-blue-300 dark:border-blue-600 text-sm font-medium rounded-md text-blue-700 dark:text-blue-300 bg-white dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors">
            üìä View Historical Results
        </a>
    </div>
    {% endif %}
    
    <!-- Back to Community -->
    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
        <a href="{% url 'democracy:decision_list' community.id %}" 
           class="flex items-center justify-center w-full px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
            ‚Üê Back to Decisions
        </a>
    </div>
    
    <!-- Theme Toggle -->
    {% block theme_toggle %}
    {% endblock %}
{% endblock sidebar_content %}

{% block header_left %}
    <div class="flex items-center">
        <h1 class="text-xl font-bold text-gray-900 dark:text-white">{{ decision.title }}</h1>
    </div>
{% endblock header_left %}

{% block content %}
    <!-- Page Content -->
    <div class="py-8 px-6">
        <div class="space-y-8">
            <!-- Section 1: Decision Header & Details -->
            <section id="decision-info" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
                <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center space-x-3 mb-2">
                                {% if status == 'active' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200">
                                        üü¢ Active - Voting Open
                                    </span>
                                {% elif status == 'closed' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                                        üî¥ Closed - Results Final
                                    </span>
                                {% elif status == 'draft' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200">
                                        ‚ö™ Draft - Not Published
                                    </span>
                                {% endif %}
                                
                                {% if decision.dt_close %}
                                    <span class="text-sm text-gray-500 dark:text-gray-400">
                                        {% if status == 'active' %}
                                            Voting closes {{ decision.dt_close|date:"M j, Y \a\t g:i A" }}
                                        {% else %}
                                            Voting closed {{ decision.dt_close|date:"M j, Y \a\t g:i A" }}
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </div>
                            
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ decision.title }}</h1>
                            <p class="mt-1 text-gray-600 dark:text-gray-400">{{ community.name }}</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            {% if can_edit %}
                                <a href="{% url 'democracy:decision_edit' community.id decision.id %}" 
                                   class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 font-medium transition-colors">
                                    ‚úèÔ∏è Edit
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="px-6 py-6">
                    <div class="prose prose-gray dark:prose-invert max-w-none">
                        <p class="text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line">{{ decision.description }}</p>
                    </div>
                </div>
            </section>

            <!-- Voting Interface -->
            {% if can_vote %}
                <section id="voting-section" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
                    <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-lg font-medium text-gray-900 dark:text-white">üó≥Ô∏è Cast Your Vote</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Use STAR voting to rate each choice from 0-5 stars</p>
                            </div>
                            {% if user_ballot %}
                                <span class="text-sm text-blue-600 dark:text-blue-400 font-medium">‚úì Vote cast - you can update anytime before deadline</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="px-6 py-6">
                    
                    <form method="post" id="vote-form" action="{% url 'democracy:vote_submit' community.id decision.id %}">
                        {% csrf_token %}
                        
                        <!-- Choices with Star Rating -->
                        <div class="space-y-6 mb-8">
                            {% for choice in decision.choices.all %}
                                <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-6 bg-gray-50 dark:bg-gray-700/50">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex-1">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">{{ choice.title }}</h3>
                                            {% if choice.description %}
                                                <p class="text-gray-600 dark:text-gray-400 text-sm">{{ choice.description }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Star Rating Interface -->
                                    <div class="flex items-center space-x-4">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Your rating:</span>
                                        <div class="flex items-center space-x-1 star-rating" data-choice-id="{{ choice.id }}">
                                            {% for star in "12345" %}
                                                <button type="button" 
                                                        class="star text-3xl transition-colors focus:outline-none cursor-pointer"
                                                        data-rating="{{ star }}"
                                                        title="{{ star }} star{{ star|pluralize }}"
                                                        style="color: var(--star-empty-color, #d1d5db);">
                                                    ‚òÜ
                                                </button>
                                            {% endfor %}
                                            <span class="ml-3 text-sm text-gray-600 dark:text-gray-400 rating-text">0 stars - No rating</span>
                                        </div>
                                        <input type="hidden" name="choice_{{ choice.id }}" value="0" class="rating-input">
                                    </div>
                                    
                                    <!-- Rating Labels -->
                                    <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                                        <div class="flex justify-between">
                                            <span>0 = No preference</span>
                                            <span>1 = Strongly oppose</span>
                                            <span>2 = Oppose</span>
                                            <span>3 = Neutral</span>
                                            <span>4 = Support</span>
                                            <span>5 = Strongly support</span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Tags Input with Chips -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Tags for this vote (optional)
                            </label>
                            
                            <!-- Selected Tags Display (Chips) -->
                            <div id="selected-tags-display" class="flex flex-wrap gap-2 mb-3 min-h-[2rem]">
                                <!-- Tags will be rendered here as chips -->
                            </div>
                            
                            <!-- Tag Input -->
                            <div class="flex gap-2">
                                <input type="text" 
                                       id="tag-input"
                                       class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Type a tag and press Enter"
                                       onkeypress="if(event.key==='Enter'){event.preventDefault();addTagFromInput();}">
                                <button type="button"
                                        onclick="addTagFromInput()"
                                        class="px-4 py-2 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 font-medium transition-colors">
                                    Add Tag
                                </button>
                            </div>
                            
                            <!-- Hidden input to store tags as comma-delimited string -->
                            <input type="hidden" name="tags" id="tags-hidden-input" value="">
                            
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                Tags help other community members follow your expertise on specific topics for delegation.
                            </p>
                        </div>
                        
                        <!-- Note: Anonymity is controlled at membership level via "My Settings" button -->
                        
                        <!-- Submit Button (Save Draft removed as requested) -->
                        <div class="flex items-center justify-between pt-6 border-t border-gray-200 dark:border-gray-600">
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                You can change your vote anytime before {{ decision.dt_close|date:"M j, Y \a\t g:i A" }}
                            </div>
                            <button type="submit" 
                                    id="submit-vote-btn"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 font-medium transition-colors">
                                {% if user_ballot %}Update Vote{% else %}Submit Vote{% endif %}
                            </button>
                        </div>
                    </form>
                    </div>
                </section>
            {% endif %}

            <!-- Current Results (if available) -->
            {% if current_results or status == 'closed' %}
                <section id="results-section" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
                    <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-lg font-medium text-gray-900 dark:text-white">
                            üìä {% if status == 'closed' %}Final Results{% else %}Current Results{% endif %}
                        </h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Live vote tallies and analysis</p>
                    </div>
                    <div class="px-6 py-6">
                        {% if current_results %}
                            <!-- Display results from the Result model -->
                            <div class="prose prose-gray dark:prose-invert max-w-none">
                                {{ current_results.report|linebreaks }}
                            </div>
                        {% else %}
                            <!-- Simple vote counts if no formal results yet -->
                            <div class="space-y-4">
                                {% for choice in decision.choices.all %}
                                    <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                                        <div>
                                            <h3 class="font-medium text-gray-900 dark:text-white">{{ choice.title }}</h3>
                                            {% if choice.description %}
                                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ choice.description }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                                {{ choice.get_vote_count }} vote{{ choice.get_vote_count|pluralize }}
                                            </div>
                                            {% if choice.get_average_stars %}
                                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                                    Avg: {{ choice.get_average_stars|floatformat:1 }} stars
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </section>
            {% endif %}

            <!-- Historical Calculation Snapshots (Plan #8) -->
            {% if snapshots.exists %}
                <section id="snapshots-section" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
                    <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-lg font-medium text-gray-900 dark:text-white">üì∏ Calculation History</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Complete audit trail of all ballot calculations and tallies</p>
                    </div>
                    <div class="px-6 py-6">
                        <table id="snapshots-table" class="display w-full">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Status</th>
                                    <th>Winner</th>
                                    <th>Participation</th>
                                    <th>Manual</th>
                                    <th>Calculated</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for snapshot in snapshots %}
                                <tr>
                                    <td>
                                        <div class="text-sm text-gray-900 dark:text-gray-100">
                                            {{ snapshot.created|date:"M j, Y" }}
                                        </div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">
                                            {{ snapshot.created|date:"g:i A" }}
                                        </div>
                                    </td>
                                    <td>
                                        {% if snapshot.is_final %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200">
                                                üî¥ FINAL
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200">
                                                üü¢ Interim
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if snapshot.winner %}
                                            <span class="text-sm text-gray-900 dark:text-gray-100 font-medium">{{ snapshot.winner.title }}</span>
                                        {% else %}
                                            <span class="text-sm text-gray-500 dark:text-gray-400 italic">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-sm text-gray-900 dark:text-gray-100">
                                            {{ snapshot.total_votes_cast }}/{{ snapshot.total_eligible_voters }}
                                            {% if snapshot.total_eligible_voters > 0 %}
                                                ({{ snapshot.total_votes_cast|floatformat:0 }}{% widthratio snapshot.total_votes_cast snapshot.total_eligible_voters 100 %}%)
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="text-sm text-gray-900 dark:text-gray-100">
                                            {{ snapshot.snapshot_data.statistics.manual_ballots|default:"-" }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="text-sm text-gray-900 dark:text-gray-100">
                                            {{ snapshot.total_calculated_votes|default:"-" }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'democracy:snapshot_detail' community.id decision.id snapshot.id %}" 
                                           class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium">
                                            View Details ‚Üí
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </section>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
<style>
:root {
    --star-empty-color: #d1d5db; /* gray-300 */
}
.dark {
    --star-empty-color: #6b7280; /* gray-500 for dark mode */
}
</style>
<script>
{% if can_manage and status == 'active' %}
// Manual Recalculation Function
function triggerManualRecalculation() {
    const btn = document.getElementById('manual-recalc-btn');
    const messageDiv = document.getElementById('recalc-message');
    const statusSpan = document.getElementById('calculation-status');
    
    // Disable button and show loading state
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Starting...';
    messageDiv.className = 'mt-2 text-xs text-center text-blue-600 dark:text-blue-400';
    messageDiv.textContent = 'Starting recalculation...';
    messageDiv.classList.remove('hidden');
    
    // Make AJAX request
    fetch('{% url "democracy:manual_recalculation" community.id decision.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success - show message and update status
            messageDiv.className = 'mt-2 text-xs text-center text-green-600 dark:text-green-400';
            messageDiv.textContent = data.message;
            
            if (data.decision_status) {
                statusSpan.textContent = data.decision_status;
            }
            
            // Start polling for status updates
            pollCalculationStatus();
            
        } else {
            // Error - show error message and re-enable button
            messageDiv.className = 'mt-2 text-xs text-center text-red-600 dark:text-red-400';
            messageDiv.textContent = data.error || 'An error occurred';
            
            btn.disabled = false;
            btn.innerHTML = 'üîÑ Recalculate Now';
        }
    })
    .catch(error => {
        console.error('Manual recalculation error:', error);
        messageDiv.className = 'mt-2 text-xs text-center text-red-600 dark:text-red-400';
        messageDiv.textContent = 'Network error. Please try again.';
        
        btn.disabled = false;
        btn.innerHTML = 'üîÑ Recalculate Now';
    });
}

// Poll calculation status to update UI in real-time
function pollCalculationStatus() {
    const statusSpan = document.getElementById('calculation-status');
    const btn = document.getElementById('manual-recalc-btn');
    const messageDiv = document.getElementById('recalc-message');
    
    let pollCount = 0;
    const maxPolls = 12; // Poll for 60 seconds (5s * 12)
    
    const pollInterval = setInterval(() => {
        pollCount++;
        
        // Fetch current status
        fetch('{% url "democracy:calculation_status" community.id decision.id %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.calculation_status) {
                // Update status display
                statusSpan.textContent = data.calculation_status;
                
                // Update visual indicators based on status
                if (data.is_calculating) {
                    // Show calculating state
                    statusSpan.className = 'font-semibold text-blue-600 dark:text-blue-400';
                    if (messageDiv && !messageDiv.classList.contains('hidden')) {
                        messageDiv.className = 'mt-2 text-xs text-center text-blue-600 dark:text-blue-400';
                        messageDiv.textContent = 'Calculation in progress...';
                    }
                } else {
                    // Show completed state
                    statusSpan.className = 'font-semibold text-green-900 dark:text-green-100';
                    
                    // Stop polling when calculation is complete
                    clearInterval(pollInterval);
                    
                    // Re-enable manual recalc button if it exists
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = 'üîÑ Recalculate Now';
                    }
                    
                    if (messageDiv && !messageDiv.classList.contains('hidden')) {
                        messageDiv.className = 'mt-2 text-xs text-center text-green-600 dark:text-green-400';
                        messageDiv.textContent = 'Calculation completed!';
                        
                        // Hide message after 3 seconds
                        setTimeout(() => {
                            messageDiv.classList.add('hidden');
                        }, 3000);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Status polling error:', error);
        });
        
        // Stop polling after max attempts
        if (pollCount >= maxPolls) {
            clearInterval(pollInterval);
            
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Recalculate Now';
            }
            
            if (messageDiv && !messageDiv.classList.contains('hidden')) {
                messageDiv.className = 'mt-2 text-xs text-center text-gray-600 dark:text-gray-400';
                messageDiv.textContent = 'Refresh page to see latest status.';
            }
        }
        
    }, 5000); // Poll every 5 seconds
}
{% endif %}

console.log('JavaScript file loading...');
console.log('User authenticated:', {{ user.is_authenticated|yesno:"true,false" }});
console.log('Can vote:', {{ can_vote|yesno:"true,false" }});
console.log('Decision status:', '{{ status }}');
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing star ratings...');
    console.log('Page URL:', window.location.href);
    console.log('Document title:', document.title);
    // Initialize star ratings
    const starRatings = document.querySelectorAll('.star-rating');
    console.log('Found', starRatings.length, 'star rating containers');
    
    // Debug: Let's see what elements exist
    console.log('Vote form exists:', !!document.getElementById('vote-form'));
    console.log('All star elements:', document.querySelectorAll('.star').length);
    console.log('All rating inputs:', document.querySelectorAll('.rating-input').length);
    console.log('Voting section exists:', !!document.getElementById('voting-section'));
    
    // Debug: Check if can_vote template variable is working correctly
    {% if can_vote %}
        console.log('Template says user can vote - voting interface should be visible');
    {% else %}
        console.log('Template says user CANNOT vote - voting interface hidden');
        console.log('This explains why stars don\'t work - the voting section is not rendered');
    {% endif %}
    
    starRatings.forEach(rating => {
        const stars = rating.querySelectorAll('.star');
        const ratingText = rating.querySelector('.rating-text');
        const hiddenInput = rating.parentElement.querySelector('.rating-input');
        const choiceId = rating.dataset.choiceId;
        
        // Set initial rating if user has already voted
        {% if user_ballot %}
            const existingVotes = {
                {% for vote in user_ballot.votes.all %}
                    "{{ vote.choice.id }}": {{ vote.stars }},
                {% endfor %}
            };
            
            if (existingVotes[choiceId]) {
                setRating(rating, existingVotes[choiceId]);
            }
        {% endif %}
        
        // Add click handlers with more robust event handling
        stars.forEach((star, index) => {
            // Click handler
            star.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const rating_value = index + 1;
                console.log('Star clicked:', rating_value, 'for choice:', choiceId);
                
                // Direct DOM update for immediate feedback
                const hiddenInput = rating.parentElement.querySelector('.rating-input');
                const ratingText = rating.querySelector('.rating-text');
                
                if (hiddenInput) {
                    hiddenInput.value = rating_value;
                    console.log('Updated hidden input to:', rating_value);
                }
                
                // Update visual feedback
                highlightStars(stars, rating_value);
                
                // Update rating text
                const labels = {
                    1: '1 star - Strongly oppose',
                    2: '2 stars - Oppose', 
                    3: '3 stars - Neutral',
                    4: '4 stars - Support',
                    5: '5 stars - Strongly support'
                };
                if (ratingText) {
                    ratingText.textContent = labels[rating_value] || `${rating_value} stars`;
                }
            });
            
            // Hover effects
            star.addEventListener('mouseenter', function() {
                console.log('Star hover:', index + 1);
                highlightStars(stars, index + 1);
            });
        });
        
        // Reset on mouse leave
        rating.addEventListener('mouseleave', function() {
            const currentRating = parseInt(hiddenInput.value) || 0;
            highlightStars(stars, currentRating);
        });
    });
    
    function setRating(ratingContainer, value) {
        const stars = ratingContainer.querySelectorAll('.star');
        const ratingText = ratingContainer.querySelector('.rating-text');
        const hiddenInput = ratingContainer.parentElement.querySelector('.rating-input');
        
        console.log('setRating called:', value, 'hiddenInput:', hiddenInput);
        if (hiddenInput) {
            hiddenInput.value = value;
            console.log('Hidden input value set to:', hiddenInput.value);
        } else {
            console.error('Hidden input not found!');
        }
        highlightStars(stars, value);
        
        // Update text
        const labels = {
            0: '0 stars - No rating',
            1: '1 star - Strongly oppose',
            2: '2 stars - Oppose', 
            3: '3 stars - Neutral',
            4: '4 stars - Support',
            5: '5 stars - Strongly support'
        };
        ratingText.textContent = labels[value] || `${value} stars`;
    }
    
    function highlightStars(stars, count) {
        console.log('highlightStars called with count:', count);
        stars.forEach((star, index) => {
            if (index < count) {
                star.textContent = '‚òÖ';
                star.style.color = '#fbbf24'; // yellow-400
                console.log('Highlighting star', index + 1, 'yellow');
            } else {
                star.textContent = '‚òÜ';
                star.style.color = 'var(--star-empty-color, #d1d5db)'; // explicit reset to empty color
                console.log('Resetting star', index + 1, 'to empty');
            }
        });
    }
    
    // Form validation and submission handling
    const voteForm = document.getElementById('vote-form');
    if (voteForm) {
        voteForm.addEventListener('submit', function(e) {
            const ratings = document.querySelectorAll('.rating-input');
            let hasRating = false;
            
            ratings.forEach(input => {
                if (parseInt(input.value) > 0) {
                    hasRating = true;
                }
            });
            
            if (!hasRating) {
                e.preventDefault();
                alert('Please rate at least one choice with 1 or more stars before submitting your vote.');
                return;
            }
            
            // Show immediate feedback that vote is being processed
            const submitBtn = document.getElementById('submit-vote-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '‚è≥ Submitting Vote...';
            }
            
            // Start polling for calculation status after form submission
            // We'll start polling after a short delay to allow the vote to be processed
            setTimeout(() => {
                console.log('Starting status polling after vote submission...');
                
                // Show a temporary message that calculation is starting
                const statusSpan = document.getElementById('calculation-status');
                if (statusSpan) {
                    statusSpan.textContent = 'Processing Vote...';
                    statusSpan.className = 'font-semibold text-blue-600 dark:text-blue-400';
                }
                
                // Start polling
                pollCalculationStatus();
            }, 2000); // Wait 2 seconds for vote to be processed and signal to fire
        });
    }
    
    // Countdown Timer for Active Decisions
    const countdownElement = document.getElementById('countdown-timer');
    if (countdownElement) {
        const deadline = new Date(countdownElement.dataset.deadline);
        
        function updateCountdown() {
            const now = new Date();
            const timeLeft = deadline - now;
            
            if (timeLeft <= 0) {
                countdownElement.textContent = 'Voting has ended';
                countdownElement.className = countdownElement.className.replace('text-green-900', 'text-red-600');
                return;
            }
            
            // Calculate time components
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            // Format display - always include seconds for excitement!
            let display = '';
            if (days > 0) {
                display = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            } else if (hours > 0) {
                display = `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                display = `${minutes}m ${seconds}s`;
            } else {
                display = `${seconds}s`;
                // Add urgency styling for last minute
                if (seconds <= 60) {
                    countdownElement.className = countdownElement.className.replace('text-green-900', 'text-red-600');
                }
            }
            
            countdownElement.textContent = display;
        }
        
        // Update immediately and then every second
        updateCountdown();
        setInterval(updateCountdown, 1000);
    }
});

// ============================================
// TAG CHIP MANAGEMENT (for ballot tags)
// ============================================
(function() {
    const selectedTags = new Set([
        {% if user_ballot_tags %}
            {% for tag in user_ballot_tags %}'{{ tag|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}
        {% endif %}
    ]);

    window.addTag = function(tag) {
        tag = tag.trim().toLowerCase();
        if (!tag || selectedTags.has(tag)) return;
        if (tag.length < 2 || tag.length > 30) {
            alert('Tags must be between 2 and 30 characters');
            return;
        }
        if (selectedTags.size >= 10) {
            alert('Maximum 10 tags allowed');
            return;
        }
        
        selectedTags.add(tag);
        renderSelectedTags();
        updateHiddenInput();
    };

    window.removeTag = function(tag) {
        selectedTags.delete(tag);
        renderSelectedTags();
        updateHiddenInput();
    };

    window.addTagFromInput = function() {
        const input = document.getElementById('tag-input');
        if (!input) return;
        
        const tag = input.value.trim();
        if (tag) {
            addTag(tag);
            input.value = '';
        }
    };

    function renderSelectedTags() {
        const container = document.getElementById('selected-tags-display');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (selectedTags.size === 0) {
            container.innerHTML = '<span class="text-sm text-gray-400 dark:text-gray-500 italic">No tags added yet</span>';
            return;
        }
        
        selectedTags.forEach(tag => {
            const pill = document.createElement('span');
            pill.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200';
            pill.innerHTML = `
                ${tag}
                <button type="button" onclick="removeTag('${tag}')" class="ml-2 text-blue-600 dark:text-blue-300 hover:text-blue-800 dark:hover:text-blue-100 font-bold">
                    √ó
                </button>
            `;
            container.appendChild(pill);
        });
    }

    function updateHiddenInput() {
        const hiddenInput = document.getElementById('tags-hidden-input');
        if (!hiddenInput) return;
        
        hiddenInput.value = Array.from(selectedTags).join(', ');
    }

    // Initialize on page load
    renderSelectedTags();
    updateHiddenInput();
})();

// ============================================
// DATATABLE INITIALIZATION FOR SNAPSHOTS (Plan #8)
// ============================================
$(document).ready(function() {
    $('#snapshots-table').DataTable({
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        order: [[0, 'desc']], // Sort by timestamp column (newest first)
        columnDefs: [
            { orderable: false, targets: [1, 6] } // Status and Action not sortable
        ],
        language: {
            search: "Search:",
            lengthMenu: "Show _MENU_ snapshots",
            info: "Showing _START_ to _END_ of _TOTAL_ snapshots",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });
});
</script>
{% endblock scripts %}
