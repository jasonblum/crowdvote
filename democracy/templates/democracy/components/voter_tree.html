{% load dict_extras %}
{# Recursive template for rendering voter delegation tree #}
{# Parameters: tree_node, user_lookup, influence_counts, max_influence, indent_level, is_nested #}

<div {% if not is_nested %}id="voter-{{ tree_node.voter_id }}"{% endif %} style="padding-left: {{ indent_level|multiply:20 }}px;" class="mb-3">
    <!-- Voter Header -->
    <div class="flex items-center space-x-2 mb-2">
        <span class="inline-block w-3 h-3 {% if tree_node.vote_type == 'manual' %}bg-green-500{% else %}bg-blue-500{% endif %} rounded-full"></span>
        {% with user=user_lookup|get_item:tree_node.voter_id %}
        {% if is_nested %}
            <!-- In nested context: make username a clickable anchor with popover -->
            <div class="relative group inline-block">
                <a href="#voter-{{ tree_node.voter_id }}" class="font-bold {% if tree_node.vote_type == 'manual' %}text-green-600 dark:text-green-400{% else %}text-blue-600 dark:text-blue-400{% endif %} hover:underline">
                    {{ user.username|default:"Unknown" }}
                </a>
                
                <!-- Popover showing ballot on hover -->
                {% if tree_node.votes %}
                <div class="absolute left-0 top-full mt-1 hidden group-hover:block z-50 w-64 p-3 bg-white dark:bg-gray-800 rounded-lg shadow-lg ring-1 ring-gray-200 dark:ring-gray-700">
                    <div class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        {{ user.username }}'s Ballot:
                    </div>
                    <div class="space-y-1">
                        {% for choice_id, vote_data in tree_node.votes.items %}
                        <div class="text-xs text-gray-700 dark:text-gray-300">
                            {{ vote_data.choice_name }}: 
                            <span class="text-yellow-600 dark:text-yellow-400 font-bold">{{ vote_data.stars|floatformat:2 }}‚≠ê</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        {% else %}
            <!-- At root level: just show username (not a link to itself) -->
            <span class="font-bold {% if tree_node.vote_type == 'manual' %}text-green-600 dark:text-green-400{% else %}text-blue-600 dark:text-blue-400{% endif %}">
                {{ user.username|default:"Unknown" }}
            </span>
        {% endif %}
        {% endwith %}
        {% if influence_counts|get_item:tree_node.voter_id %}
        <span class="text-gray-500 dark:text-gray-500">({{ influence_counts|get_item:tree_node.voter_id }})</span>
        {% if influence_counts|get_item:tree_node.voter_id == max_influence %}
        <span>üèÜ</span>
        {% endif %}
        {% endif %}
        {% if tree_node.vote_type == 'manual' %}
        <span class="text-gray-600 dark:text-gray-400">cast manual ballot</span>
        {% if tree_node.tags %}
        <span class="text-orange-600 dark:text-orange-400">[{{ tree_node.tags|join:", " }}]</span>
        {% endif %}
        {% else %}
        <span class="text-gray-600 dark:text-gray-400">calculating ballot...</span>
        {% endif %}
    </div>
    
    {% if tree_node.vote_type == 'manual' and not is_nested %}
        <!-- Manual ballot at root level - show votes -->
        {% if tree_node.votes %}
        <div style="padding-left: 20px;" class="space-y-1 text-xs">
            {% for choice_id, vote_data in tree_node.votes.items %}
            <div class="text-gray-700 dark:text-gray-300">
                {{ vote_data.choice_name }}: 
                <span class="text-yellow-600 dark:text-yellow-400 font-bold">{{ vote_data.stars|floatformat:2 }}‚≠ê</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% elif tree_node.vote_type == 'calculated' %}
        <!-- Calculated ballot - show following relationships recursively -->
        {% for following_item in tree_node.following %}
            <div style="padding-left: 20px;" class="mb-2">
                <!-- Show "Following X on [tags]" -->
                <div class="flex items-center space-x-1 mb-1">
                    <span class="text-blue-600 dark:text-blue-400">‚îú‚îÄ</span>
                    <span class="text-gray-600 dark:text-gray-400">Following</span>
                    {% if following_item.followee_tree %}
                        {% with ft=following_item.followee_tree %}
                        <span class="inline-block w-2 h-2 {% if ft.vote_type == 'manual' %}bg-green-500{% else %}bg-blue-500{% endif %} rounded-full"></span>
                        {% with followee_user=user_lookup|get_item:ft.voter_id %}
                        <!-- Followee username with popover -->
                        <div class="relative group inline-block">
                            <a href="#voter-{{ ft.voter_id }}" class="font-semibold {% if ft.vote_type == 'manual' %}text-green-600 dark:text-green-400{% else %}text-blue-600 dark:text-blue-400{% endif %} hover:underline">
                                {{ followee_user.username|default:"Unknown" }}
                            </a>
                            
                            <!-- Popover showing ballot on hover -->
                            {% if ft.votes %}
                            <div class="absolute left-0 top-full mt-1 hidden group-hover:block z-50 w-64 p-3 bg-white dark:bg-gray-800 rounded-lg shadow-lg ring-1 ring-gray-200 dark:ring-gray-700">
                                <div class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">
                                    {{ followee_user.username }}'s Ballot:
                                </div>
                                <div class="space-y-1">
                                    {% for choice_id, vote_data in ft.votes.items %}
                                    <div class="text-xs text-gray-700 dark:text-gray-300">
                                        {{ vote_data.choice_name }}: 
                                        <span class="text-yellow-600 dark:text-yellow-400 font-bold">{{ vote_data.stars|floatformat:2 }}‚≠ê</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endwith %}
                        {% endwith %}
                    {% else %}
                        <span class="text-gray-500 dark:text-gray-500">[circular reference prevented]</span>
                    {% endif %}
                    <span class="text-gray-600 dark:text-gray-400">on</span>
                    {% if following_item.edge.tags %}
                    <span class="text-purple-600 dark:text-purple-400">[{{ following_item.edge.tags|join:", " }}]</span>
                    {% else %}
                    <span class="text-purple-600 dark:text-purple-400">[ALL]</span>
                    {% endif %}
                </div>
                
                <!-- Recursively render followee's tree (indented) -->
                {% if following_item.followee_tree %}
                    {% include "democracy/components/voter_tree.html" with tree_node=following_item.followee_tree indent_level=indent_level|add:1 is_nested=True %}
                {% endif %}
                
                <!-- Show tag match result -->
                <div style="padding-left: 20px;" class="text-xs mb-1">
                    {% if following_item.edge.active_for_decision %}
                    <span class="text-green-600 dark:text-green-400">‚úì MATCH ‚Üí inheriting votes</span>
                    {% else %}
                    <span class="text-red-600 dark:text-red-400">‚úó NO MATCH ‚Üí not inheriting</span>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
        
        <!-- Final calculated ballot -->
        <div style="padding-left: 0px;" class="mt-2">
            <div class="flex items-center space-x-1 mb-2">
                <span class="text-blue-600 dark:text-blue-400">‚îî‚îÄ</span>
                <span class="font-bold text-blue-600 dark:text-blue-400">
                    {% with user=user_lookup|get_item:tree_node.voter_id %}
                        {{ user.username|default:"Unknown" }}
                    {% endwith %}
                </span>
                <span class="text-gray-600 dark:text-gray-400">ballot calculated</span>
                {% if tree_node.inherited_tags %}
                <span class="text-orange-600 dark:text-orange-400">[{{ tree_node.inherited_tags|join:", " }}]</span>
                {% endif %}
            </div>
            
            {% if tree_node.votes %}
            <div style="padding-left: 20px;" class="space-y-1 text-xs">
                {% for choice_id, vote_data in tree_node.votes.items %}
                <div class="text-gray-700 dark:text-gray-300">
                    {{ vote_data.choice_name }}: 
                    <span class="text-yellow-600 dark:text-yellow-400 font-bold">{{ vote_data.stars|floatformat:2 }}‚≠ê</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    {% endif %}
</div>

