{% load static %}

<!-- Delegation Tree Component -->
<div class="delegation-tree" id="delegation-tree">
    <!-- Tree Controls -->
    <div class="flex items-center justify-between mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
        <div class="flex items-center space-x-4">
            <h4 class="text-sm font-medium text-gray-900 dark:text-white">Tree Controls:</h4>
            <button type="button" onclick="expandAllNodes()" class="px-3 py-1 text-xs font-medium text-blue-600 dark:text-blue-400 hover:text-blue-500 border border-blue-300 dark:border-blue-600 rounded-md hover:bg-blue-50 dark:hover:bg-blue-900">
                Expand All
            </button>
            <button type="button" onclick="collapseAllNodes()" class="px-3 py-1 text-xs font-medium text-gray-600 dark:text-gray-400 hover:text-gray-500 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                Collapse All
            </button>
            <button type="button" onclick="togglePrintMode()" class="px-3 py-1 text-xs font-medium text-gray-600 dark:text-gray-400 hover:text-gray-500 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                Print Mode
            </button>
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400">
            {{ delegation_tree_data.nodes|length }} voters ‚Ä¢ {{ delegation_tree_data.edges|length }} relationships
        </div>
    </div>

    <!-- Tree Visualization -->
    <div class="tree-container font-mono text-sm leading-relaxed">
        <!-- Tree Statistics -->
        <div class="tree-stats mb-4 p-3 bg-blue-50 dark:bg-blue-900 rounded border text-xs">
            <strong>Delegation Tree:</strong><br>
            Total voters: {{ delegation_tree_data.nodes|length }}<br>
            Following relationships: {{ delegation_tree_data.edges|length }}<br>
            Inheritance chains: {{ delegation_tree_data.inheritance_chains|length }}
        </div>
        
        <!-- Hierarchical Tree Structure -->
        <div class="delegation-hierarchy">
            {% comment %}
            Build the actual tree structure by finding root nodes (manual voters) 
            and then showing calculated voters as branches under them
            {% endcomment %}
            
            <!-- Manual Voters (Root Nodes) -->
            <div class="root-nodes">
                <h5 class="text-sm font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                    üå≥ Manual Voters (Tree Roots)
                    <span class="ml-2 text-xs text-gray-500">‚Äî These voters cast their own ballots</span>
                </h5>
                
                {% for node in delegation_tree_data.nodes %}
                    {% if node.vote_type == 'manual' %}
                        <div class="manual-voter-node mb-4 p-3 border-l-4 border-green-500 bg-green-50 dark:bg-green-900 rounded" id="voter-{{ node.voter_id }}">
                            <!-- Manual Voter Header -->
                            <div class="voter-header flex items-center gap-2 mb-2">
                                <span class="vote-type-badge bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-200 px-2 py-1 rounded text-xs">
                                    üó≥Ô∏è Manual Vote
                                </span>
                                <span class="username font-bold">
                                    {% if node.is_anonymous %}
                                        <span class="text-gray-600">Anonymous Voter {{ node.voter_id|slice:":8" }}</span>
                                    {% else %}
                                        <a href="{% url 'accounts:member_profile' node.username %}" class="text-green-700 dark:text-green-300 hover:underline">{{ node.username }}</a>
                                    {% endif %}
                                </span>
                                {% if node.tags %}
                                    <div class="tags-inline flex gap-1">
                                        {% for tag in node.tags %}
                                            <span class="tag-badge bg-green-200 text-green-800 dark:bg-green-700 dark:text-green-200 px-2 py-1 rounded text-xs">{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Manual Vote Details -->
                            {% if node.votes %}
                                <div class="votes-display mb-2 ml-4">
                                    {% for choice_id, vote_data in node.votes.items %}
                                        <div class="vote-line flex items-center gap-3 mb-1">
                                            <span class="choice-name text-sm font-medium">{{ vote_data.choice_name }}:</span>
                                            <div class="stars-visual" data-stars="{{ vote_data.stars }}">
                                                {% with stars_int=vote_data.stars|floatformat:0 stars_remainder=vote_data.stars|floatformat:2 %}
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= stars_int|add:0 %}
                                                            <span class="star text-yellow-500 text-base">‚òÖ</span>
                                                        {% else %}
                                                            <span class="star text-gray-300 text-base">‚òÜ</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endwith %}
                                            </div>
                                            <span class="stars-numeric text-xs text-gray-600 dark:text-gray-400">({{ vote_data.stars }})</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- Show who follows this manual voter -->
                            {% with followers='' %}
                                {% for edge in delegation_tree_data.edges %}
                                    {% if edge.followee == node.voter_id and edge.active_for_decision %}
                                        {% if followers %}
                                            {% with followers=followers|add:", " %}{% endwith %}
                                        {% endif %}
                                        {% for follower_node in delegation_tree_data.nodes %}
                                            {% if follower_node.voter_id == edge.follower %}
                                                {% with followers=followers|add:follower_node.username %}{% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                                {% if followers %}
                                    <div class="followers-indicator text-xs text-green-600 dark:text-green-400 ml-4">
                                        ‚ÜóÔ∏è Influences: {{ followers }}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            <!-- Calculated Voters (Delegation Branches) -->
            <div class="calculated-nodes mt-6">
                <h5 class="text-sm font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                    üîó Calculated Voters (Delegation Network)
                    <span class="ml-2 text-xs text-gray-500">‚Äî These voters inherit through delegation</span>
                </h5>
                
                {% for node in delegation_tree_data.nodes %}
                    {% if node.vote_type == 'calculated' %}
                        <div class="calculated-voter-node mb-3 p-3 border-l-4 border-purple-500 bg-purple-50 dark:bg-purple-900 rounded" id="voter-{{ node.voter_id }}">
                            <!-- Calculated Voter Header -->
                            <div class="voter-header flex items-center gap-2 mb-2">
                                <span class="vote-type-badge bg-purple-100 text-purple-800 dark:bg-purple-800 dark:text-purple-200 px-2 py-1 rounded text-xs">
                                    üìä Calculated
                                </span>
                                <span class="username font-bold">
                                    {% if node.is_anonymous %}
                                        <span class="text-gray-600">Anonymous Voter {{ node.voter_id|slice:":8" }}</span>
                                    {% else %}
                                        <a href="{% url 'accounts:member_profile' node.username %}" class="text-purple-700 dark:text-purple-300 hover:underline">{{ node.username }}</a>
                                    {% endif %}
                                </span>
                                {% if node.inherited_tags %}
                                    <div class="inherited-tags-inline flex gap-1">
                                        {% for tag in node.inherited_tags %}
                                            <span class="tag-badge bg-purple-200 text-purple-800 dark:bg-purple-700 dark:text-purple-200 px-2 py-1 rounded text-xs">{{ tag }} (inherited)</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Calculated Vote Results -->
                            {% if node.votes %}
                                <div class="votes-display mb-2 ml-4">
                                    {% for choice_id, vote_data in node.votes.items %}
                                        <div class="vote-line flex items-center gap-3 mb-1">
                                            <span class="choice-name text-sm font-medium">{{ vote_data.choice_name }}:</span>
                                            <div class="stars-visual" data-stars="{{ vote_data.stars }}">
                                                {% with stars_int=vote_data.stars|floatformat:0 %}
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= stars_int|add:0 %}
                                                            <span class="star text-yellow-500 text-base">‚òÖ</span>
                                                        {% else %}
                                                            <span class="star text-gray-300 text-base">‚òÜ</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endwith %}
                                            </div>
                                            <span class="stars-numeric text-xs text-gray-600 dark:text-gray-400">({{ vote_data.stars|floatformat:2 }})</span>
                                            {% if vote_data.sources %}
                                                <span class="sources-info text-xs text-purple-600 dark:text-purple-400">‚Üê from {{ vote_data.sources|length }} source{{ vote_data.sources|length|pluralize }}</span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- Delegation Sources Tree -->
                            {% if node.votes %}
                                {% for choice_id, vote_data in node.votes.items %}
                                    {% if vote_data.sources %}
                                        <div class="delegation-sources ml-6 mt-2 p-2 bg-gray-50 dark:bg-gray-800 rounded border">
                                            <div class="sources-header text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                üìà Inherited from ({{ vote_data.choice_name }}):
                                            </div>
                                            {% for source in vote_data.sources %}
                                                <div class="source-line flex items-center gap-2 ml-3 mb-1 text-xs">
                                                    <span class="bullet">‚Ü≥</span>
                                                    {% if source.is_anonymous %}
                                                        <span class="source-name text-gray-600">Anonymous ({{ source.from_voter_id|slice:":3" }}...)</span>
                                                    {% else %}
                                                        <a href="#voter-{{ source.from_voter_id }}" class="source-name text-blue-600 dark:text-blue-400 hover:underline">{{ source.from_voter }}</a>
                                                    {% endif %}
                                                    <span class="source-stars font-mono">{{ source.stars }}‚≠ê</span>
                                                    {% if source.tags %}
                                                        <div class="source-tags flex gap-1">
                                                            {% for tag in source.tags %}
                                                                <span class="tag-mini bg-blue-100 text-blue-700 dark:bg-blue-800 dark:text-blue-200 px-1 py-0 rounded text-xs">{{ tag }}</span>
                                                            {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
        <!-- Debug Section (Collapsible) -->
        <details class="debug-section mt-6">
            <summary class="text-xs text-gray-500 cursor-pointer bg-gray-100 dark:bg-gray-800 p-2 rounded">üêõ Debug Data (click to expand)</summary>
            <div class="debug-content mt-2 p-3 bg-gray-50 dark:bg-gray-900 rounded border text-xs">
                <strong>Sample node data:</strong>
                <pre>{{ delegation_tree_data.nodes.0|default:"None"|pprint }}</pre>
                <strong>Sample edge data:</strong>
                <pre>{{ delegation_tree_data.edges.0|default:"None"|pprint }}</pre>
            </div>
        </details>
    </div>
</div>

<!-- Delegation Tree Styles -->
<style>
.delegation-tree {
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Courier New', monospace;
    line-height: 1.6;
}

.tree-container {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1.5rem;
}

.dark .tree-container {
    background: #1f2937;
    border-color: #374151;
}

.tree-node {
    margin-left: 20px;
    border-left: 2px solid #e5e7eb;
    padding-left: 15px;
    margin-bottom: 8px;
    position: relative;
}

.dark .tree-node {
    border-left-color: #4b5563;
}

.tree-node.manual {
    border-left-color: #10b981; /* Green for manual votes */
}

.tree-node.calculated {
    border-left-color: #8b5cf6; /* Purple for calculated votes */
}

.tree-node.depth-0 {
    margin-left: 0;
    border-left: none;
    padding-left: 0;
}

.tree-node::before {
    content: '';
    position: absolute;
    left: -2px;
    top: 0;
    width: 8px;
    height: 2px;
    background-color: inherit;
}

.voter-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
}

.vote-type-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.375rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.vote-type-badge.manual {
    background-color: #d1fae5;
    color: #065f46;
}

.dark .vote-type-badge.manual {
    background-color: #064e3b;
    color: #6ee7b7;
}

.vote-type-badge.calculated {
    background-color: #ede9fe;
    color: #5b21b6;
}

.dark .vote-type-badge.calculated {
    background-color: #4c1d95;
    color: #c4b5fd;
}

.username {
    font-weight: 600;
    color: #1f2937;
    cursor: pointer;
    text-decoration: none;
}

.dark .username {
    color: #f9fafb;
}

.username:hover {
    color: #2563eb;
    text-decoration: underline;
}

.dark .username:hover {
    color: #60a5fa;
}

.username.anonymous {
    color: #6b7280;
    cursor: default;
}

.dark .username.anonymous {
    color: #9ca3af;
}

.username.anonymous:hover {
    color: #6b7280;
    text-decoration: none;
}

.fractional-stars {
    display: inline-flex;
    align-items: center;
    gap: 0.125rem;
}

.star {
    width: 1rem;
    height: 1rem;
    display: inline-block;
    position: relative;
}

.star-full {
    color: #fbbf24;
}

.star-empty {
    color: #d1d5db;
}

.dark .star-empty {
    color: #6b7280;
}

.star-partial {
    position: relative;
    color: #d1d5db;
}

.dark .star-partial {
    color: #6b7280;
}

.star-partial::before {
    content: '‚òÖ';
    position: absolute;
    left: 0;
    color: #fbbf24;
    overflow: hidden;
    width: var(--fill-percent, 50%);
}

.choice-votes {
    margin-left: 1rem;
    margin-top: 0.25rem;
    font-size: 0.875rem;
}

.choice-vote {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.25rem 0;
    border-bottom: 1px solid #f3f4f6;
}

.dark .choice-vote {
    border-bottom-color: #374151;
}

.choice-vote:last-child {
    border-bottom: none;
}

.choice-title {
    font-weight: 500;
    color: #374151;
}

.dark .choice-title {
    color: #d1d5db;
}

.vote-details {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stars-display {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.tag-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.25rem;
}

.tag-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.375rem;
    background-color: #f3f4f6;
    color: #374151;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.dark .tag-badge {
    background-color: #374151;
    color: #d1d5db;
}

.tag-badge.inherited {
    background-color: #ddd6fe;
    color: #5b21b6;
}

.dark .tag-badge.inherited {
    background-color: #4c1d95;
    color: #c4b5fd;
}

.inheritance-sources {
    margin-left: 1.5rem;
    margin-top: 0.5rem;
    padding-left: 1rem;
    border-left: 1px dashed #d1d5db;
    font-size: 0.8125rem;
}

.dark .inheritance-sources {
    border-left-color: #4b5563;
}

.source-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.25rem 0;
    color: #6b7280;
}

.dark .source-item {
    color: #9ca3af;
}

.expand-toggle {
    cursor: pointer;
    user-select: none;
    color: #6b7280;
    font-weight: bold;
    margin-right: 0.25rem;
}

.dark .expand-toggle {
    color: #9ca3af;
}

.expand-toggle:hover {
    color: #374151;
}

.dark .expand-toggle:hover {
    color: #d1d5db;
}

.collapsible-content {
    transition: all 0.2s ease-in-out;
}

.collapsible-content.collapsed {
    display: none;
}

/* Print Styles */
@media print {
    .delegation-tree {
        color: black !important;
        background: white !important;
        font-size: 12px;
    }
    
    .tree-container {
        border: 1px solid black !important;
        background: white !important;
    }
    
    .tree-node {
        border-left-color: black !important;
        page-break-inside: avoid;
    }
    
    .interactive-elements,
    .expand-toggle {
        display: none !important;
    }
    
    .collapsible-content {
        display: block !important;
    }
    
    .vote-type-badge,
    .tag-badge {
        border: 1px solid black !important;
        background: white !important;
        color: black !important;
    }
}

.print-mode .interactive-elements,
.print-mode .expand-toggle {
    display: none !important;
}

.print-mode .collapsible-content {
    display: block !important;
}
</style>

<!-- Delegation Tree JavaScript -->
<script>
// Tree Control Functions
function expandAllNodes() {
    // For debugging template, expand all <details> elements
    document.querySelectorAll('#delegation-tree details').forEach(details => {
        details.open = true;
    });
    
    // Future: expand delegation tree nodes
    document.querySelectorAll('.collapsible-content.collapsed').forEach(content => {
        content.classList.remove('collapsed');
        const toggle = content.previousElementSibling?.querySelector('.expand-toggle');
        if (toggle) {
            toggle.textContent = '‚ñº';
        }
    });
    
    console.log('Expanded all nodes');
}

function collapseAllNodes() {
    // For debugging template, collapse all <details> elements
    document.querySelectorAll('#delegation-tree details').forEach(details => {
        details.open = false;
    });
    
    // Future: collapse delegation tree nodes
    document.querySelectorAll('.collapsible-content:not(.collapsed)').forEach(content => {
        if (content.closest('.tree-node')?.dataset.depth !== '0') {
            content.classList.add('collapsed');
            const toggle = content.previousElementSibling?.querySelector('.expand-toggle');
            if (toggle) {
                toggle.textContent = '‚ñ∂';
            }
        }
    });
    
    console.log('Collapsed all nodes');
}

function togglePrintMode() {
    const tree = document.getElementById('delegation-tree');
    tree.classList.toggle('print-mode');
    
    // Also add a visual indicator when in print mode
    const modeIndicator = tree.classList.contains('print-mode') ? ' (Print Mode)' : '';
    console.log('Print mode toggled' + modeIndicator);
}

function toggleNode(element) {
    const content = element.parentElement.nextElementSibling;
    if (content && content.classList.contains('collapsible-content')) {
        content.classList.toggle('collapsed');
        element.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    }
}

// Fractional Stars Display
function renderFractionalStars(stars, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const fullStars = Math.floor(stars);
    const partialStar = stars - fullStars;
    const emptyStars = 5 - Math.ceil(stars);
    
    let html = '';
    
    // Full stars
    for (let i = 0; i < fullStars; i++) {
        html += '<span class="star star-full">‚òÖ</span>';
    }
    
    // Partial star
    if (partialStar > 0) {
        const fillPercent = Math.round(partialStar * 100);
        html += `<span class="star star-partial" style="--fill-percent: ${fillPercent}%">‚òÖ</span>`;
    }
    
    // Empty stars
    for (let i = 0; i < emptyStars; i++) {
        html += '<span class="star star-empty">‚òÜ</span>';
    }
    
    container.innerHTML = html;
}

// Initialize fractional stars on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-stars]').forEach(element => {
        const stars = parseFloat(element.dataset.stars);
        if (!isNaN(stars)) {
            renderFractionalStarsInline(stars, element);
        }
    });
});

// Enhanced fractional stars function that works with inline elements
function renderFractionalStarsInline(stars, container) {
    if (!container) return;
    
    const fullStars = Math.floor(stars);
    const partialStar = stars - fullStars;
    const emptyStars = 5 - Math.ceil(stars);
    
    let html = '';
    
    // Full stars
    for (let i = 0; i < fullStars; i++) {
        html += '<span class="star text-yellow-500 text-sm">‚òÖ</span>';
    }
    
    // Partial star
    if (partialStar > 0) {
        const fillPercent = Math.round(partialStar * 100);
        html += `<span class="star star-partial text-sm" style="--fill-percent: ${fillPercent}%">‚òÖ</span>`;
    }
    
    // Empty stars
    for (let i = 0; i < emptyStars; i++) {
        html += '<span class="star text-gray-300 text-sm">‚òÜ</span>';
    }
    
    container.innerHTML = html;
}

// Hover Popover System (will be enhanced in Phase 3)
function showCalculationDetails(element, data) {
    // Placeholder for hover popover functionality
    console.log('Calculation details:', data);
}
</script>
