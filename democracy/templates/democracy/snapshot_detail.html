{% extends "base.html" %}
{% load static %}
{% load dict_extras %}

{% block title %}Snapshot Details - {{ decision.title }} - {{ community.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Delegation tree visualization styles */
    .delegation-indent-0 { padding-left: 0; }
    .delegation-indent-1 { padding-left: 1.5rem; }
    .delegation-indent-2 { padding-left: 3rem; }
    .delegation-indent-3 { padding-left: 4.5rem; }
    .delegation-indent-4 { padding-left: 6rem; }
</style>
{% endblock %}

{% block sidebar %}
    <!-- Sidebar navigation -->
    <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">On This Page</h3>
    <nav class="space-y-1 mb-6">
        <a href="#statistics" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
            <span class="mr-2">üìä</span> Statistics
        </a>
        {% if manual_nodes %}
        <a href="#manual-section" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
            <span class="mr-2">üü¢</span> Manual Ballots
        </a>
        {% endif %}
        {% if calculated_nodes %}
        <a href="#calculated-section" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
            <span class="mr-2">üîµ</span> Calculated Ballots
        </a>
        {% endif %}
        <a href="#results-section" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
            <span class="mr-2">üèÜ</span> Results
        </a>
    </nav>

    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
        <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Navigation</h3>
        <nav class="space-y-1">
            <a href="{% url 'democracy:decision_detail' community_id=community.id decision_id=decision.id %}" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                <span class="mr-2">‚Üê</span> Back to Decision
            </a>
        </nav>
    </div>
{% endblock %}

{% block content %}
    <div class="space-y-6">
        <!-- Header -->
        <div class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg overflow-hidden">
            <div class="px-6 py-5">
                <div class="flex items-center space-x-3 mb-3">
                    <span class="text-3xl">üì∏</span>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Snapshot Details</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ snapshot.created|date:"F j, Y g:i A" }}</p>
                    </div>
                </div>
                <div class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-2">{{ decision.title }}</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-300">{{ decision.description }}</p>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <section id="statistics" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
            <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-medium text-gray-900 dark:text-white">üìä Snapshot Statistics</h2>
            </div>
            <div class="px-6 py-6">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üü¢</span>
                            <div>
                                <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ stats.manual_ballots }}</div>
                                <div class="text-sm text-gray-700 dark:text-gray-300">Manual Ballots</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üîµ</span>
                            <div>
                                <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ stats.calculated_ballots }}</div>
                                <div class="text-sm text-gray-700 dark:text-gray-300">Calculated Ballots</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">‚ö´</span>
                            <div>
                                <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ stats.no_ballot }}</div>
                                <div class="text-sm text-gray-700 dark:text-gray-300">No Ballot</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                            <div>
                                <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ stats.circular_prevented }}</div>
                                <div class="text-sm text-gray-700 dark:text-gray-300">Circular Prevented</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üìè</span>
                            <div>
                                <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ stats.max_delegation_depth }}</div>
                                <div class="text-sm text-gray-700 dark:text-gray-300">Max Depth</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üë•</span>
                            <div>
                                <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ stats.total_members }}</div>
                                <div class="text-sm text-gray-700 dark:text-gray-300">Total Members</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Manual Ballots Section -->
        {% if manual_nodes %}
        <section id="manual-section" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
            <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-medium text-gray-900 dark:text-white">üü¢ Manual Ballots</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Direct votes cast by community members</p>
            </div>
            <div class="px-6 py-6">
                <div class="space-y-4 font-mono text-sm">
                    {% for node in manual_nodes %}
                    <div id="voter-{{ node.voter_id }}" class="border-l-4 border-green-500 pl-4 py-2 bg-green-50 dark:bg-green-900/10">
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span class="font-bold text-gray-900 dark:text-white">
                                {% with user=user_lookup|get_item:node.voter_id %}
                                    {% if user %}
                                        {{ user.username }}
                                    {% else %}
                                        Unknown User
                                    {% endif %}
                                {% endwith %}
                            </span>
                            {% if influence_counts|get_item:node.voter_id %}
                            <span class="text-gray-500 dark:text-gray-400">({{ influence_counts|get_item:node.voter_id }})</span>
                            {% if influence_counts|get_item:node.voter_id == max_influence %}
                            <span class="text-yellow-500">üèÜ</span>
                            {% endif %}
                            {% endif %}
                            <span class="text-gray-600 dark:text-gray-400">cast manual ballot</span>
                            {% if node.tags %}
                            <span class="text-orange-600 dark:text-orange-400">[{{ node.tags|join:", " }}]</span>
                            {% endif %}
                        </div>
                        {% if node.votes %}
                        <div class="mt-2 ml-5 text-xs space-y-1">
                            {% for choice_id, vote_data in node.votes.items %}
                            <div class="text-gray-700 dark:text-gray-300">
                                {{ vote_data.choice_name }}: 
                                <span class="text-yellow-600 dark:text-yellow-400 font-bold">
                                    {{ vote_data.stars }}‚≠ê
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Calculated Ballots Section (Delegation Tree) -->
        {% if calculated_trees %}
        <section id="calculated-section" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
            <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-medium text-gray-900 dark:text-white">üîµ Calculated Ballots (Delegation Tree)</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Watch how votes are inherited and averaged through delegation</p>
            </div>
            <div class="px-6 py-6 bg-gray-50 dark:bg-gray-900 rounded-lg font-mono text-sm">
                {% for tree in calculated_trees %}
                    {% include "democracy/components/voter_tree.html" with tree_node=tree indent_level=0 is_nested=False %}
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- STAR Voting Results Section -->
        {% if snapshot.winner %}
        <section id="results-section" class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 rounded-lg">
            <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-medium text-gray-900 dark:text-white">üèÜ STAR Voting Results</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Score Then Automatic Runoff tally</p>
            </div>
            <div class="px-6 py-6">
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-400 dark:border-yellow-600 rounded-lg p-6 mb-6">
                    <div class="text-center">
                        <div class="text-sm text-yellow-700 dark:text-yellow-300 font-medium mb-2">WINNER</div>
                        <div class="text-3xl font-bold text-yellow-900 dark:text-yellow-100">{{ snapshot.winner.title }}</div>
                    </div>
                </div>
                
                {% if snapshot.tally_log %}
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 font-mono text-xs">
                    {% for log_line in snapshot.tally_log %}
                    <div class="text-gray-700 dark:text-gray-300 py-1">{{ log_line }}</div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </section>
        {% endif %}
    </div>
{% endblock %}
